<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presidi e Distretti Sanitari ASP Messina</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            text-align: center;
        }

        .subtitle {
            text-align: center;
            margin-top: 5px;
            font-size: 14px;
            opacity: 0.9;
        }

        #map-container {
            display: flex;
            height: calc(100vh - 80px);
        }

        #map {
            flex: 1;
            height: 100%;
        }

        #sidebar {
            width: 320px;
            background: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        #sidebar h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #2d3748;
        }

        .distretto-info {
            margin-bottom: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .distretto-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .comuni-list {
            list-style: none;
            font-size: 14px;
            color: #4a5568;
            line-height: 1.6;
        }

        .comuni-list li {
            padding: 4px 0;
            padding-left: 12px;
            position: relative;
            cursor: pointer;
            transition: color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .comuni-list li:hover {
            color: #667eea;
            font-weight: 500;
        }

        .comuni-list li:before {
            content: "‚Ä¢";
            position: absolute;
            left: 0;
            color: #667eea;
        }

        .comune-presidio-count {
            font-size: 11px;
            background: #e2e8f0;
            color: #4a5568;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
            margin-left: 8px;
        }

        .legend {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .legend h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #2d3748;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 13px;
            padding: 4px;
            border-radius: 6px;
            transition: background 0.2s;
            cursor: pointer;
        }

        .legend-item:hover {
            background: #f7fafc;
        }

        .legend-item input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        .legend-item label {
            cursor: pointer;
            display: flex;
            align-items: center;
            flex: 1;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 8px;
            border: 2px solid #e2e8f0;
        }

        .info-box {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            font-size: 14px;
            z-index: 1000;
            max-width: 300px;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .info-box.show {
            display: block;
        }

        .info-box h3 {
            margin: 0;
            font-size: 16px;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .info-box p {
            margin: 4px 0;
            color: #4a5568;
        }

        /* Search Bar */
        .search-island {
            position: absolute;
            top: 20px;
            left: 120px;
            background: white;
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            width: 320px;
        }

        .search-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-results {
            margin-top: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .search-result-item {
            padding: 8px 10px;
            cursor: pointer;
            border-radius: 6px;
            font-size: 13px;
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: #f7fafc;
        }

        .search-result-comune {
            font-weight: 600;
            color: #2d3748;
        }

        .search-result-distretto {
            font-size: 12px;
            color: #718096;
            margin-top: 2px;
        }

        .search-no-results {
            padding: 8px 10px;
            font-size: 13px;
            color: #a0aec0;
            text-align: center;
        }

        /* Context Menu */
        .context-menu {
            position: absolute;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            padding: 6px 0;
            z-index: 10000;
            min-width: 150px;
            display: none;
        }

        .context-menu.show {
            display: block;
        }

        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
        }

        .context-menu-item:hover {
            background: #f7fafc;
        }

        .context-menu-item.edit {
            color: #667eea;
        }

        .context-menu-item.save {
            color: #48bb78;
        }

        .context-menu-item:before {
            content: '';
            width: 16px;
            height: 16px;
            margin-right: 8px;
        }

        /* Presidio count badge */
        .presidio-count {
            font-size: 11px;
            background: #e2e8f0;
            color: #4a5568;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
            font-weight: 600;
        }

        /* Footer copyright */
        .footer-copyright {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            color: #4a5568;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        /* Stats badge */
        .stats-badge {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 14px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            font-size: 13px;
            border-left: 4px solid #e53e3e;
        }

        .stats-badge .stats-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .stats-badge .stats-missing {
            color: #e53e3e;
            font-weight: 600;
            font-size: 14px;
        }

        .stats-badge .stats-success {
            color: #48bb78;
            font-weight: 600;
            font-size: 14px;
            margin-top: 2px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            #map-container {
                flex-direction: column;
            }

            #sidebar {
                width: 100%;
                max-height: 40vh;
            }

            #map {
                height: 60vh;
            }
        }

        .leaflet-popup-content {
            font-family: inherit;
        }

        .popup-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 8px;
            color: #2d3748;
        }

        .popup-text {
            font-size: 14px;
            color: #4a5568;
        }

        /* Presidi controls section */
        .presidi-controls {
            margin-top: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 4px solid #48bb78;
        }

        .presidi-controls h2 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #2d3748;
        }

        .presidi-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 12px;
        }

        .presidio-item {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            margin-bottom: 4px;
            background: white;
            border-radius: 6px;
            font-size: 13px;
            transition: background 0.2s;
        }

        .presidio-item:hover {
            background: #edf2f7;
        }

        .presidio-item input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        .presidio-item label {
            cursor: pointer;
            flex: 1;
            color: #4a5568;
        }

        .print-options {
            margin-top: 12px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .print-options-title {
            font-size: 12px;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            font-size: 12px;
            color: #4a5568;
        }

        .radio-item input[type="radio"] {
            margin-right: 6px;
            cursor: pointer;
        }

        .radio-item label {
            cursor: pointer;
            flex: 1;
        }

        .control-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-save {
            background: #48bb78;
            color: white;
        }

        .btn-save:hover {
            background: #38a169;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(72, 187, 120, 0.3);
        }

        .btn-reset {
            background: #e53e3e;
            color: white;
        }

        .btn-reset:hover {
            background: #c53030;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(229, 62, 62, 0.3);
        }

        .btn-print {
            background: #667eea;
            color: white;
        }

        .btn-print:hover {
            background: #5568d3;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        /* Presidio labels for print */
        .presidio-label {
            display: none;
            position: absolute;
            background: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            color: #2d3748;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            pointer-events: none;
            z-index: 1000;
            transform: translate(-50%, -100%);
            margin-top: -8px;
        }

        /* Print styles */
        @media print {
            @page {
                size: A3 landscape;
                margin: 1cm;
            }

            body {
                background: white;
            }

            header {
                background: #667eea;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            #sidebar,
            .search-island,
            .stats-badge,
            .footer-copyright,
            .context-menu,
            .leaflet-control-zoom {
                display: none !important;
            }

            #map-container {
                height: 100vh;
                display: block;
            }

            #map {
                width: 100% !important;
                height: calc(100vh - 80px) !important;
            }

            .presidio-label {
                display: block !important;
            }

            .leaflet-popup {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Presidi e Distretti Sanitari ASP Messina</h1>
        <div class="subtitle">Mappa interattiva dei distretti, comuni e presidi sanitari</div>
    </header>

    <div id="map-container">
        <div id="map">
            <!-- Search Island -->
            <div class="search-island">
                <input type="text" class="search-input" id="search-input" placeholder="Cerca un comune...">
                <div class="search-results" id="search-results"></div>
            </div>
        </div>
        <div id="sidebar">
            <div class="legend">
                <h3>Legenda</h3>
                <div id="legend-content"></div>
            </div>

            <!-- Presidi Controls -->
            <div class="presidi-controls">
                <h2>üè• Gestione Presidi</h2>
                <div class="presidi-list" id="presidi-list"></div>

                <!-- Print Options -->
                <div class="print-options">
                    <div class="print-options-title">üè∑Ô∏è Etichette Stampa:</div>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="label-nome" name="print-label" value="nome" checked>
                            <label for="label-nome">Nome Presidio</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="label-comune" name="print-label" value="comune">
                            <label for="label-comune">Comune/Quartiere</label>
                        </div>
                    </div>
                </div>

                <div class="control-buttons">
                    <button class="btn btn-save" id="btn-save" title="Salva lo stato corrente dei presidi">üíæ Salva</button>
                    <button class="btn btn-reset" id="btn-reset" title="Ripristina tutti i presidi">üîÑ Reset</button>
                    <button class="btn btn-print" id="btn-print" title="Stampa la mappa">üñ®Ô∏è Stampa</button>
                </div>
            </div>

            <h2>Distretti e Comuni</h2>
            <div id="distretti-list"></div>
        </div>
    </div>

    <div id="info-box" class="info-box"></div>

    <!-- Context Menu -->
    <div id="context-menu" class="context-menu">
        <div class="context-menu-item edit" id="menu-edit">Modifica posizione</div>
        <div class="context-menu-item save" id="menu-save">Salva posizione</div>
    </div>

    <!-- Copyright -->
    <div class="footer-copyright">
        ¬© Ing. Roberto De Domenico per ASP 5 Messina
    </div>

    <!-- Stats Badge -->
    <div class="stats-badge">
        <div class="stats-title">Stato Geolocalizzazione</div>
        <div class="stats-missing" id="stats-missing">Caricamento...</div>
        <div class="stats-success" id="stats-success"></div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Initialize BASE_PATH based on hostname
        let BASE_PATH = '';

        async function loadConfig() {
            const hostname = window.location.hostname;

            // Only load config from API if running on ws1.asp.messina.it
            if (hostname === 'ws1.asp.messina.it') {
                try {
                    console.log('Running on ws1.asp.messina.it, loading config...');
                    const response = await fetch('https://ws1.asp.messina.it/api/v1/apps/presidi-distretti-asp-messina/config');
                    if (response.ok) {
                        const config = await response.json();
                        BASE_PATH = config.data.basePath || '';
                        console.log('Config loaded, using BASE_PATH:', BASE_PATH);
                    }
                    else
                    {
                        console.error('Failed to load config, status:', response.status);
                        BASE_PATH = '';
                    }
                } catch (err) {
                    console.error('Error loading config from API:', err);
                    BASE_PATH = '';
                }
            } else {
                console.log('Not running on ws1.asp.messina.it, using empty BASE_PATH');
                BASE_PATH = '';
            }
        }

        async function initApp() {
            // Load configuration first
            await loadConfig();

            // Inizializza mappa
            const map = L.map('map').setView([38.19, 15.25], 10);

        // Aggiungi tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        // Colori per i distretti
        const colors = [
            '#667eea', '#764ba2', '#f093fb', '#f5576c',
            '#4facfe', '#00f2fe', '#43e97b', '#38f9d7',
            '#fa709a', '#fee140', '#30cfd0', '#330867'
        ];

        const distrettiData = {};
        const distrettiLayers = {}; // Store layers by distretto for filtering
        const allFeatures = []; // Store all features for search
        const presidiMarkers = {}; // Store presidi markers by distretto
        const presidiCounts = {}; // Count presidi per distretto
        const presidiCountsByComune = {}; // Count presidi per comune
        const comuneFeatures = {}; // Store features by comune for zooming
        let selectedDistretto = null;
        let editingMarker = null; // Marker currently being edited
        const infoBox = document.getElementById('info-box');
        const contextMenu = document.getElementById('context-menu');
        const allPresidiMarkers = []; // Store all presidi markers for visibility control
        const presidiVisibility = {}; // Track visibility state of each presidio
        const presidiLabels = {}; // Store labels for print

        // Load and display statistics
        fetch(BASE_PATH + '/api/stats')
            .then(r => r.json())
            .then(stats => {
                const missingElement = document.getElementById('stats-missing');
                if (stats.missing === 0) {
                    // Hide missing count if all are geocoded
                    missingElement.style.display = 'none';
                } else {
                    missingElement.textContent =
                        `‚ùå ${stats.missing} presidi non geolocalizzati`;
                }
                document.getElementById('stats-success').textContent =
                    `‚úì ${stats.percentage}% geolocalizzati (${stats.geocoded}/${stats.total})`;
            })
            .catch(err => {
                console.error('Error loading stats:', err);
                document.getElementById('stats-missing').textContent = 'Errore caricamento';
            });

        // Carica i dati
        Promise.all([
            fetch(BASE_PATH + '/distretti-detailed.geojson').then(r => r.json()),
            fetch(BASE_PATH + '/presidi.geojson').then(r => r.json())
        ]).then(([detailedData, presidiData]) => {
            console.log('Dati caricati:', detailedData, presidiData);

            // Raggruppa per distretto
            detailedData.features.forEach(feature => {
                const distretto = feature.properties.distretto;
                if (!distrettiData[distretto]) {
                    distrettiData[distretto] = {
                        features: [],
                        comuni: new Set()
                    };
                }
                distrettiData[distretto].features.push(feature);

                if (feature.properties.comune) {
                    distrettiData[distretto].comuni.add(feature.properties.comune);
                }
            });

            // Crea layer per ogni distretto
            const distrettiNames = Object.keys(distrettiData).sort();

            distrettiNames.forEach((distretto, index) => {
                const color = colors[index % colors.length];
                const data = distrettiData[distretto];

                // Initialize layer group for this distretto
                distrettiLayers[distretto] = {
                    layers: [],
                    color: color,
                    visible: true
                };

                data.features.forEach(feature => {
                    const comune = feature.properties.comune;

                    // Store feature with distretto info for search
                    allFeatures.push({
                        comune: comune,
                        distretto: distretto,
                        feature: feature,
                        color: color
                    });

                    // Store feature by comune for zooming
                    if (!comuneFeatures[comune]) {
                        comuneFeatures[comune] = [];
                    }
                    comuneFeatures[comune].push(feature);

                    const layer = L.geoJSON(feature, {
                        style: {
                            fillColor: color,
                            weight: 1,
                            opacity: 1,
                            color: 'white',
                            fillOpacity: 0.5
                        }
                    });

                    layer.on('mouseover', function(e) {
                        e.target.setStyle({
                            fillOpacity: 0.8,
                            weight: 2
                        });

                        const comune = feature.properties.comune;
                        infoBox.innerHTML = `
                            <h3>${distretto}</h3>
                            <p><strong>Comune:</strong> ${comune}</p>
                        `;
                        infoBox.classList.add('show');
                    });

                    layer.on('mouseout', function(e) {
                        if (selectedDistretto !== distretto) {
                            e.target.setStyle({
                                fillOpacity: 0.5,
                                weight: 1
                            });
                        }
                        infoBox.classList.remove('show');
                    });

                    layer.on('click', function(e) {
                        selectedDistretto = distretto;

                        // Mostra popup
                        const comuniArray = Array.from(data.comuni).sort();
                        const popupContent = `
                            <div class="popup-title">${distretto}</div>
                            <div class="popup-text">
                                <strong>Comuni (${comuniArray.length}):</strong><br>
                                ${comuniArray.join(', ')}
                            </div>
                        `;

                        L.popup()
                            .setLatLng(e.latlng)
                            .setContent(popupContent)
                            .openOn(map);
                    });

                    layer.addTo(map);
                    distrettiLayers[distretto].layers.push(layer);
                });
            });

            // Count presidi per distretto and comune (before creating sidebar)
            presidiData.features.forEach(presidio => {
                const distretto = presidio.properties.distretto;
                const comune = presidio.properties.comune;

                if (distretto) {
                    presidiCounts[distretto] = (presidiCounts[distretto] || 0) + 1;
                }

                if (comune) {
                    presidiCountsByComune[comune] = (presidiCountsByComune[comune] || 0) + 1;
                }
            });

            // Popola sidebar
            const legendContent = document.getElementById('legend-content');
            const distrettiList = document.getElementById('distretti-list');

            distrettiNames.forEach((distretto, index) => {
                const color = colors[index % colors.length];
                const data = distrettiData[distretto];
                const comuniArray = Array.from(data.comuni).sort();

                // Aggiungi alla legenda con checkbox
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                const checkboxId = `checkbox-${distretto.replace(/\s+/g, '-')}`;
                legendItem.innerHTML = `
                    <input type="checkbox" id="${checkboxId}" checked>
                    <label for="${checkboxId}">
                        <div class="legend-color" style="background-color: ${color}"></div>
                        <span>${distretto}</span>
                    </label>
                `;
                legendContent.appendChild(legendItem);

                // Add event listener for checkbox
                const checkbox = legendItem.querySelector('input[type="checkbox"]');
                checkbox.addEventListener('change', function() {
                    const visible = this.checked;
                    distrettiLayers[distretto].visible = visible;

                    // Show or hide all layers for this distretto
                    distrettiLayers[distretto].layers.forEach(layer => {
                        if (visible) {
                            map.addLayer(layer);
                        } else {
                            map.removeLayer(layer);
                        }
                    });
                });

                // Aggiungi alla lista distretti
                const distrettoInfo = document.createElement('div');
                distrettoInfo.className = 'distretto-info';
                distrettoInfo.innerHTML = `
                    <div class="distretto-name" style="color: ${color}">${distretto}</div>
                    <ul class="comuni-list" id="comuni-list-${distretto.replace(/\s+/g, '-')}">
                    </ul>
                `;
                distrettiList.appendChild(distrettoInfo);

                // Add comuni with presidio counts and click handlers
                const comuniList = distrettoInfo.querySelector('.comuni-list');
                comuniArray.forEach(comune => {
                    const count = presidiCountsByComune[comune] || 0;
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span>${comune}</span>
                        ${count > 0 ? `<span class="comune-presidio-count">${count} üè•</span>` : ''}
                    `;
                    li.dataset.comune = comune;

                    // Add click handler to zoom to comune
                    li.addEventListener('click', function() {
                        const comuneName = this.dataset.comune;
                        if (comuneFeatures[comuneName] && comuneFeatures[comuneName].length > 0) {
                            // Create temporary layer to get bounds
                            const tempLayer = L.geoJSON({
                                type: 'FeatureCollection',
                                features: comuneFeatures[comuneName]
                            });
                            const bounds = tempLayer.getBounds();

                            // Zoom to comune
                            map.fitBounds(bounds, {
                                padding: [50, 50],
                                maxZoom: 13
                            });

                            // Show popup
                            const center = bounds.getCenter();
                            L.popup()
                                .setLatLng(center)
                                .setContent(`
                                    <div class="popup-title">${comuneName}</div>
                                    <div class="popup-text">
                                        <strong>Distretto:</strong> ${distretto}<br>
                                        ${count > 0 ? `<strong>Presidi:</strong> ${count}` : ''}
                                    </div>
                                `)
                                .openOn(map);
                        }
                    });

                    comuniList.appendChild(li);
                });
            });

            // Fit bounds
            const bounds = L.geoJSON(detailedData).getBounds();
            map.fitBounds(bounds, { padding: [20, 20] });

            // Setup search functionality
            const searchInput = document.getElementById('search-input');
            const searchResults = document.getElementById('search-results');
            let currentHighlight = null;

            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase().trim();
                searchResults.innerHTML = '';

                if (searchTerm.length < 2) {
                    return;
                }

                // Search through all features
                const matches = allFeatures.filter(item =>
                    item.comune.toLowerCase().includes(searchTerm)
                ).slice(0, 10); // Limit to 10 results

                if (matches.length === 0) {
                    searchResults.innerHTML = '<div class="search-no-results">Nessun comune trovato</div>';
                    return;
                }

                matches.forEach(match => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    resultItem.innerHTML = `
                        <div class="search-result-comune">${match.comune}</div>
                        <div class="search-result-distretto">Distretto: ${match.distretto}</div>
                    `;

                    resultItem.addEventListener('click', function() {
                        // Get bounds of the feature
                        const featureLayer = L.geoJSON(match.feature);
                        const featureBounds = featureLayer.getBounds();

                        // Zoom to feature
                        map.fitBounds(featureBounds, {
                            padding: [50, 50],
                            maxZoom: 13
                        });

                        // Remove previous highlight
                        if (currentHighlight) {
                            map.removeLayer(currentHighlight);
                        }

                        // Highlight the feature
                        currentHighlight = L.geoJSON(match.feature, {
                            style: {
                                fillColor: match.color,
                                weight: 3,
                                opacity: 1,
                                color: '#ff6b6b',
                                fillOpacity: 0.7
                            }
                        }).addTo(map);

                        // Show popup
                        const center = featureBounds.getCenter();
                        L.popup()
                            .setLatLng(center)
                            .setContent(`
                                <div class="popup-title">${match.comune}</div>
                                <div class="popup-text">
                                    <strong>Distretto:</strong> ${match.distretto}
                                </div>
                            `)
                            .openOn(map);

                        // Clear search
                        searchInput.value = '';
                        searchResults.innerHTML = '';

                        // Remove highlight after 5 seconds
                        setTimeout(() => {
                            if (currentHighlight) {
                                map.removeLayer(currentHighlight);
                                currentHighlight = null;
                            }
                        }, 5000);
                    });

                    searchResults.appendChild(resultItem);
                });
            });

            // Load visibility state from localStorage
            function loadPresidiVisibility() {
                try {
                    const saved = localStorage.getItem('presidi-visibility');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        Object.assign(presidiVisibility, parsed);
                        console.log('Stato presidi caricato da localStorage');
                    }
                } catch (error) {
                    console.error('Errore nel caricamento dello stato:', error);
                }
            }

            // Save visibility state to localStorage
            function savePresidiVisibility() {
                try {
                    localStorage.setItem('presidi-visibility', JSON.stringify(presidiVisibility));
                    alert('‚úì Stato presidi salvato con successo!');
                    console.log('Stato presidi salvato in localStorage');
                } catch (error) {
                    console.error('Errore nel salvataggio dello stato:', error);
                    alert('‚úó Errore nel salvataggio dello stato');
                }
            }

            // Reset visibility state
            function resetPresidiVisibility() {
                if (confirm('Sei sicuro di voler ripristinare lo stato iniziale? Tutti i presidi saranno nuovamente visibili.')) {
                    try {
                        localStorage.removeItem('presidi-visibility');
                        // Reset all to visible
                        allPresidiMarkers.forEach(markerData => {
                            presidiVisibility[markerData.nome] = true;
                            map.addLayer(markerData.marker);
                            // Update checkbox
                            const checkbox = document.getElementById(`presidio-${markerData.id}`);
                            if (checkbox) checkbox.checked = true;
                        });
                        alert('‚úì Stato ripristinato! Tutti i presidi sono ora visibili.');
                        console.log('Stato presidi ripristinato');
                    } catch (error) {
                        console.error('Errore nel reset dello stato:', error);
                        alert('‚úó Errore nel reset dello stato');
                    }
                }
            }

            // Load saved state
            loadPresidiVisibility();

            // Load and display presidi
            console.log(`Caricamento ${presidiData.features.length} presidi...`);

            // Create custom marker icon with hospital emoji
            const presidioIcon = L.divIcon({
                className: 'presidio-marker',
                html: '<div style="font-size: 28px; text-align: center; line-height: 1; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));">üè•</div>',
                iconSize: [28, 28],
                iconAnchor: [14, 14]
            });

            // Add presidi markers
            presidiData.features.forEach((presidio, index) => {
                const [lon, lat] = presidio.geometry.coordinates;
                const distretto = presidio.properties.distretto;
                const nome = presidio.properties.nome;
                const indirizzo = presidio.properties.indirizzo;
                const comune = presidio.properties.comune;

                const marker = L.marker([lat, lon], {
                    icon: presidioIcon,
                    draggable: false
                }).addTo(map);

                marker.presidioData = {
                    nome: nome,
                    indirizzo: indirizzo,
                    distretto: distretto,
                    comune: comune
                };

                // Popup on click
                marker.on('click', function(e) {
                    const popupContent = `
                        <div class="popup-title">${nome}</div>
                        <div class="popup-text">
                            <strong>Indirizzo:</strong> ${indirizzo}<br>
                            ${distretto ? `<strong>Distretto:</strong> ${distretto}<br>` : ''}
                            ${comune ? `<strong>Comune:</strong> ${comune}` : ''}
                        </div>
                    `;

                    L.popup()
                        .setLatLng(e.latlng)
                        .setContent(popupContent)
                        .openOn(map);
                });

                // Right-click for context menu
                marker.on('contextmenu', function(e) {
                    L.DomEvent.preventDefault(e);

                    editingMarker = marker;

                    // Position context menu
                    const x = e.originalEvent.pageX;
                    const y = e.originalEvent.pageY;

                    contextMenu.style.left = x + 'px';
                    contextMenu.style.top = y + 'px';
                    contextMenu.classList.add('show');

                    // Update menu based on draggable state
                    if (marker.options.draggable) {
                        document.getElementById('menu-edit').style.display = 'none';
                        document.getElementById('menu-save').style.display = 'block';
                    } else {
                        document.getElementById('menu-edit').style.display = 'block';
                        document.getElementById('menu-save').style.display = 'none';
                    }
                });

                // Create label for print
                const labelDiv = document.createElement('div');
                labelDiv.className = 'presidio-label';
                labelDiv.textContent = nome;
                labelDiv.style.left = '0px';
                labelDiv.style.top = '0px';
                document.body.appendChild(labelDiv);

                // Store marker with visibility data
                const markerData = {
                    id: index,
                    marker: marker,
                    nome: nome,
                    distretto: distretto,
                    comune: comune,
                    lat: lat,
                    lon: lon,
                    labelDiv: labelDiv  // Store reference to label
                };
                allPresidiMarkers.push(markerData);
                presidiLabels[nome] = markerData;  // Store full markerData instead of just label

                // Initialize visibility (default true or from saved state)
                if (presidiVisibility[nome] === undefined) {
                    presidiVisibility[nome] = true;
                }

                // Apply saved visibility state
                if (presidiVisibility[nome] === false) {
                    map.removeLayer(marker);
                }

                if (distretto) {
                    if (!presidiMarkers[distretto]) {
                        presidiMarkers[distretto] = [];
                    }
                    presidiMarkers[distretto].push(marker);
                }
            });

            // Populate presidi list in sidebar
            const presidiList = document.getElementById('presidi-list');
            allPresidiMarkers
                .sort((a, b) => a.nome.localeCompare(b.nome))
                .forEach(markerData => {
                    const item = document.createElement('div');
                    item.className = 'presidio-item';

                    const checkboxId = `presidio-${markerData.id}`;
                    const isVisible = presidiVisibility[markerData.nome] !== false;

                    item.innerHTML = `
                        <input type="checkbox" id="${checkboxId}" ${isVisible ? 'checked' : ''}>
                        <label for="${checkboxId}" title="${markerData.nome}">${markerData.nome}</label>
                    `;

                    const checkbox = item.querySelector('input');
                    checkbox.addEventListener('change', function() {
                        const visible = this.checked;
                        presidiVisibility[markerData.nome] = visible;

                        if (visible) {
                            map.addLayer(markerData.marker);
                        } else {
                            map.removeLayer(markerData.marker);
                        }
                    });

                    presidiList.appendChild(item);
                });

            // Update legend with presidio counts
            distrettiNames.forEach((distretto, index) => {
                const count = presidiCounts[distretto] || 0;
                const checkbox = document.getElementById(`checkbox-${distretto.replace(/\s+/g, '-')}`);
                if (checkbox) {
                    const label = checkbox.nextElementSibling;
                    if (label && count > 0) {
                        const countBadge = document.createElement('span');
                        countBadge.className = 'presidio-count';
                        countBadge.textContent = `${count} P`;
                        countBadge.title = `${count} presidi`;
                        label.appendChild(countBadge);
                    }
                }
            });

            // Context menu handlers
            document.getElementById('menu-edit').addEventListener('click', function() {
                if (editingMarker) {
                    editingMarker.options.draggable = true;
                    editingMarker.dragging.enable();
                    contextMenu.classList.remove('show');

                    // Visual feedback
                    editingMarker._icon.style.cursor = 'move';
                    editingMarker._icon.style.transform = 'scale(1.3)';
                }
            });

            document.getElementById('menu-save').addEventListener('click', async function() {
                if (editingMarker) {
                    const latlng = editingMarker.getLatLng();
                    const nome = editingMarker.presidioData.nome;

                    try {
                        const response = await fetch(BASE_PATH + '/api/update-presidio', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                nome: nome,
                                lat: latlng.lat,
                                lon: latlng.lng
                            })
                        });

                        const result = await response.json();

                        if (result.success) {
                            // Disable dragging
                            editingMarker.options.draggable = false;
                            editingMarker.dragging.disable();

                            // Reset visual feedback
                            editingMarker._icon.style.cursor = '';
                            editingMarker._icon.style.transform = '';

                            alert(`‚úì Posizione salvata per ${nome}`);
                        } else {
                            alert(`‚úó Errore nel salvataggio: ${result.error}`);
                        }
                    } catch (error) {
                        alert(`‚úó Errore nel salvataggio: ${error.message}`);
                    }

                    contextMenu.classList.remove('show');
                    editingMarker = null;
                }
            });

            // Hide context menu on map click
            map.on('click', function() {
                contextMenu.classList.remove('show');
            });

            // Hide context menu on scroll
            map.on('movestart', function() {
                contextMenu.classList.remove('show');
            });

            // Button event listeners
            document.getElementById('btn-save').addEventListener('click', savePresidiVisibility);
            document.getElementById('btn-reset').addEventListener('click', resetPresidiVisibility);
            document.getElementById('btn-print').addEventListener('click', function() {
                printMap();
            });

            // Print function
            function printMap() {
                // Get all visible presidi
                const visiblePresidi = allPresidiMarkers.filter(md =>
                    presidiVisibility[md.nome] !== false
                );

                if (visiblePresidi.length === 0) {
                    alert('Nessun presidio visibile da stampare!');
                    return;
                }

                // Get selected label type
                const labelType = document.querySelector('input[name="print-label"]:checked').value;

                // Calculate bounds of visible presidi
                const bounds = L.latLngBounds(
                    visiblePresidi.map(md => [md.lat, md.lon])
                );

                // Store current view
                const currentCenter = map.getCenter();
                const currentZoom = map.getZoom();

                // Fit to visible presidi with padding
                map.fitBounds(bounds, {
                    padding: [100, 100],
                    maxZoom: 14
                });

                // Position labels for visible presidi
                setTimeout(() => {
                    visiblePresidi.forEach(markerData => {
                        const point = map.latLngToContainerPoint([markerData.lat, markerData.lon]);
                        const markerInfo = presidiLabels[markerData.nome];
                        if (markerInfo && markerInfo.labelDiv) {
                            const label = markerInfo.labelDiv;

                            // Update label text based on selection
                            if (labelType === 'comune') {
                                // Use comune (which is the quartiere for Messina)
                                label.textContent = markerInfo.comune || markerInfo.nome;
                            } else {
                                // Use nome presidio
                                label.textContent = markerInfo.nome;
                            }

                            label.style.left = point.x + 'px';
                            label.style.top = point.y + 'px';
                        }
                    });

                    // Hide labels for non-visible presidi
                    allPresidiMarkers.forEach(markerData => {
                        if (presidiVisibility[markerData.nome] === false) {
                            const markerInfo = presidiLabels[markerData.nome];
                            if (markerInfo && markerInfo.labelDiv) {
                                markerInfo.labelDiv.style.display = 'none';
                            }
                        }
                    });

                    // Trigger print dialog
                    setTimeout(() => {
                        window.print();

                        // Restore view after print
                        setTimeout(() => {
                            map.setView(currentCenter, currentZoom);
                            // Reset label display and text
                            allPresidiMarkers.forEach(markerData => {
                                const markerInfo = presidiLabels[markerData.nome];
                                if (markerInfo && markerInfo.labelDiv) {
                                    markerInfo.labelDiv.style.display = '';
                                    // Reset to nome presidio
                                    markerInfo.labelDiv.textContent = markerInfo.nome;
                                }
                            });
                        }, 500);
                    }, 500);
                }, 500);
            }

        }).catch(error => {
            console.error('Errore nel caricamento dei dati:', error);
            alert('Errore nel caricamento dei dati. Controlla la console.');
        });
        }

        // Initialize the app
        initApp();
    </script>
</body>
</html>
