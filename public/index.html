<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presidi e Distretti Sanitari ASP Messina</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            text-align: center;
        }

        .subtitle {
            text-align: center;
            margin-top: 5px;
            font-size: 14px;
            opacity: 0.9;
        }

        #map-container {
            display: flex;
            height: calc(100vh - 80px);
        }

        #map {
            flex: 1;
            height: 100%;
        }

        #sidebar {
            width: 320px;
            background: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        #sidebar h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #2d3748;
        }

        .distretto-info {
            margin-bottom: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .distretto-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .distretto-name input[type="checkbox"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
            flex-shrink: 0;
            accent-color: #667eea;
            transition: all 0.2s ease;
        }

        .distretto-name input[type="checkbox"]:hover {
            transform: scale(1.1);
        }

        .distretto-name label {
            cursor: pointer;
            flex: 1;
        }

        .comuni-list {
            list-style: none;
            font-size: 14px;
            color: #4a5568;
            line-height: 1.6;
        }

        .comuni-list li {
            padding: 4px 0;
            padding-left: 12px;
            position: relative;
            cursor: pointer;
            transition: color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .comuni-list li:hover {
            color: #667eea;
            font-weight: 500;
        }

        .comuni-list li:before {
            content: "‚Ä¢";
            position: absolute;
            left: 0;
            color: #667eea;
        }

        .comune-presidio-count {
            font-size: 11px;
            background: #e2e8f0;
            color: #4a5568;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
            margin-left: 8px;
        }

        .settings {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .settings h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #2d3748;
        }

        .settings-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 4px;
            background: #f7fafc;
            border-radius: 6px;
            font-size: 13px;
        }

        .settings-item input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        .settings-item label {
            cursor: pointer;
            flex: 1;
            color: #4a5568;
        }

        .settings-item .radio-group {
            width: 100%;
        }

        .settings-item .radio-item {
            margin-bottom: 4px;
        }

        .settings-item .radio-item label {
            font-size: 12px;
        }

        .legend {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .legend h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #2d3748;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 13px;
            padding: 4px;
            border-radius: 6px;
            transition: background 0.2s;
            cursor: pointer;
        }

        .legend-item:hover {
            background: #f7fafc;
        }

        .legend-item input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        .legend-item label {
            cursor: pointer;
            display: flex;
            align-items: center;
            flex: 1;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 8px;
            border: 2px solid #e2e8f0;
        }

        .info-box {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            font-size: 14px;
            z-index: 1000;
            max-width: 300px;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .info-box.show {
            display: block;
        }

        .info-box h3 {
            margin: 0;
            font-size: 16px;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .info-box p {
            margin: 4px 0;
            color: #4a5568;
        }

        /* Search Bar - now in sidebar */
        .search-input {
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-results {
            margin-top: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .search-result-item {
            padding: 8px 10px;
            cursor: pointer;
            border-radius: 6px;
            font-size: 13px;
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: #f7fafc;
        }

        .search-result-comune {
            font-weight: 600;
            color: #2d3748;
        }

        .search-result-distretto {
            font-size: 12px;
            color: #718096;
            margin-top: 2px;
        }

        .search-no-results {
            padding: 8px 10px;
            font-size: 13px;
            color: #a0aec0;
            text-align: center;
        }

        /* Context Menu */
        .context-menu {
            position: absolute;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            padding: 6px 0;
            z-index: 10000;
            min-width: 150px;
            display: none;
        }

        .context-menu.show {
            display: block;
        }

        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
        }

        .context-menu-item:hover {
            background: #f7fafc;
        }

        .context-menu-item.edit {
            color: #667eea;
        }

        .context-menu-item.save {
            color: #48bb78;
        }

        .context-menu-item.measure {
            color: #f59e0b;
        }

        .context-menu-item.add {
            color: #10b981;
        }

        .context-menu-item.change-icon {
            color: #8b5cf6;
        }

        .context-menu-item.delete {
            color: #e53e3e;
        }

        .context-menu-item:before {
            content: '';
            width: 16px;
            height: 16px;
            margin-right: 8px;
        }

        /* Distance measurement line */
        .distance-line {
            stroke: #f59e0b;
            stroke-width: 3;
            stroke-dasharray: 10, 5;
            fill: none;
        }

        .distance-marker {
            background: #f59e0b;
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            width: 12px;
            height: 12px;
        }

        /* Presidio count badge */
        .presidio-count {
            font-size: 11px;
            background: #e2e8f0;
            color: #4a5568;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
            font-weight: 600;
        }

        /* Footer copyright */
        .footer-copyright {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            color: #4a5568;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        /* Stats badge */
        .stats-badge {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 14px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            font-size: 13px;
            border-left: 4px solid #e53e3e;
        }

        .stats-badge .stats-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .stats-badge .stats-missing {
            color: #e53e3e;
            font-weight: 600;
            font-size: 14px;
        }

        .stats-badge .stats-success {
            color: #48bb78;
            font-weight: 600;
            font-size: 14px;
            margin-top: 2px;
        }

        /* Distretti legend badge */
        .distretti-legend-badge {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            font-size: 12px;
            border-left: 4px solid #667eea;
            max-width: 280px;
            transition: opacity 0.3s, transform 0.3s;
        }

        .distretti-legend-badge.hidden {
            opacity: 0;
            transform: translateX(320px);
            pointer-events: none;
        }

        .distretti-legend-badge .legend-badge-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .distretti-legend-badge .distretto-id-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            font-size: 11px;
            border-bottom: 1px solid #e2e8f0;
        }

        .distretti-legend-badge .distretto-id-item:last-child {
            border-bottom: none;
        }

        .distretti-legend-badge .distretto-id-name {
            color: #4a5568;
            font-weight: 500;
        }

        .distretti-legend-badge .distretto-id-code {
            color: #667eea;
            font-weight: 600;
            font-family: 'Courier New', monospace;
            background: #f7fafc;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .distretti-legend-badge .legend-badge-hint {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e2e8f0;
            color: #718096;
            font-size: 10px;
            font-style: italic;
        }

        .distretti-legend-badge .close-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #f7fafc;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #718096;
            font-size: 16px;
            transition: all 0.2s;
        }

        .distretti-legend-badge .close-btn:hover {
            background: #e2e8f0;
            color: #2d3748;
        }

        /* Toggle button for reopening legend */
        .toggle-legend-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(102, 126, 234, 0.95);
            color: white;
            border: none;
            border-radius: 8px;
            width: 44px;
            height: 44px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 999;
            transition: all 0.2s;
        }

        .toggle-legend-btn:hover {
            background: rgba(85, 104, 211, 0.95);
            transform: scale(1.05);
        }

        .toggle-legend-btn.visible {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            #map-container {
                flex-direction: column;
            }

            #sidebar {
                width: 100%;
                max-height: 40vh;
            }

            #map {
                height: 60vh;
            }
        }

        .leaflet-popup-content {
            font-family: inherit;
        }

        .popup-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 8px;
            color: #2d3748;
        }

        .popup-text {
            font-size: 14px;
            color: #4a5568;
        }

        /* Permanent tooltip styles */
        .presidio-permanent-tooltip {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #333;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            color: #2d3748;
            font-weight: 600;
            font-size: 12px;
            padding: 4px 8px;
            white-space: nowrap;
            pointer-events: none;
            transition: font-size 0.2s ease, opacity 0.2s ease;
        }

        .presidio-permanent-tooltip:before {
            border-right-color: #333 !important;
        }

        /* Comune hover tooltip */
        .comune-hover-tooltip {
            background: rgba(0, 0, 0, 0.85) !important;
            border: 1px solid white !important;
            border-radius: 4px !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
            color: white !important;
            font-weight: 600 !important;
            font-size: 12px !important;
            padding: 4px 8px !important;
            pointer-events: none !important;
        }

        .comune-hover-tooltip:before {
            display: none !important;
        }

        /* Connector line for distant labels */
        .label-connector-line {
            stroke: #666666;
            stroke-width: 1;
            stroke-opacity: 0.5;
            stroke-dasharray: 4, 4;
            fill: none;
            pointer-events: none;
        }

        /* Control section */
        .control-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .control-section h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #2d3748;
        }

        /* Presidi under comuni */
        .presidi-comune-list {
            list-style: none;
            margin-top: 8px;
            margin-left: 12px;
            padding-left: 12px;
            border-left: 2px solid #e2e8f0;
        }

        .presidio-item {
            display: flex;
            align-items: center;
            padding: 4px 0;
            font-size: 12px;
            color: #4a5568;
        }

        .presidio-item input[type="checkbox"] {
            margin-right: 6px;
            cursor: pointer;
            width: 14px;
            height: 14px;
            flex-shrink: 0;
        }

        .presidio-item label {
            cursor: pointer;
            flex: 1;
            color: #4a5568;
        }

        .presidio-item:hover label {
            color: #667eea;
        }

        .print-options {
            margin-top: 12px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .print-options-title {
            font-size: 12px;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            font-size: 12px;
            color: #4a5568;
        }

        .radio-item input[type="radio"] {
            margin-right: 6px;
            cursor: pointer;
        }

        .radio-item label {
            cursor: pointer;
            flex: 1;
        }

        .control-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-save {
            background: #48bb78;
            color: white;
        }

        .btn-save:hover {
            background: #38a169;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(72, 187, 120, 0.3);
        }

        .btn-reset {
            background: #e53e3e;
            color: white;
        }

        .btn-reset:hover {
            background: #c53030;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(229, 62, 62, 0.3);
        }

        .btn-print {
            background: #667eea;
            color: white;
        }

        .btn-print:hover {
            background: #5568d3;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .btn-export {
            background: #f59e0b;
            color: white;
        }

        .btn-export:hover {
            background: #d97706;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }

        /* Map type buttons */
        .map-type-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .map-type-btn {
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            background: white;
            color: #4a5568;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .map-type-btn:hover {
            border-color: #667eea;
            background: #f7fafc;
            color: #667eea;
        }

        .map-type-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .map-type-btn.active:hover {
            background: #5568d3;
            border-color: #5568d3;
            color: white;
        }

        .btn-import {
            background: #8b5cf6;
            color: white;
        }

        .btn-import:hover {
            background: #7c3aed;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 10001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 16px;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .modal-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-footer {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .modal-btn-primary {
            background: #667eea;
            color: white;
        }

        .modal-btn-primary:hover {
            background: #5568d3;
        }

        .modal-btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .modal-btn-secondary:hover {
            background: #cbd5e0;
        }

        /* Hidden file input */
        .hidden-input {
            display: none;
        }

        /* Icon selection modal */
        .icon-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .icon-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .icon-option:hover {
            border-color: #667eea;
            background: #f7fafc;
            transform: translateY(-2px);
        }

        .icon-option.selected {
            border-color: #667eea;
            background: #eef2ff;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .icon-option-emoji {
            font-size: 36px;
            margin-bottom: 8px;
        }

        .icon-option-label {
            font-size: 12px;
            font-weight: 600;
            color: #4a5568;
            text-align: center;
        }

        .icon-option.selected .icon-option-label {
            color: #667eea;
        }

        /* Presidio labels for print */
        .presidio-label {
            display: none;
            position: absolute;
            background: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            color: #2d3748;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            pointer-events: none;
            z-index: 1000;
            transform: translate(-50%, -100%);
            margin-top: -8px;
        }

        /* Print styles */
        @media print {
            @page {
                size: A3 landscape;
                margin: 1cm;
            }

            body {
                background: white;
            }

            header {
                background: #667eea;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            #sidebar,
            .stats-badge,
            .distretti-legend-badge,
            .footer-copyright,
            .context-menu,
            .leaflet-control-zoom {
                display: none !important;
            }

            #map-container {
                height: 100vh;
                display: block;
            }

            #map {
                width: 100% !important;
                height: calc(100vh - 80px) !important;
            }

            .presidio-label {
                display: block !important;
            }

            .leaflet-popup,
            .leaflet-tooltip {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Presidi e Distretti Sanitari ASP Messina</h1>
        <div class="subtitle">Mappa interattiva dei distretti, comuni e presidi sanitari</div>
    </header>

    <div id="map-container">
        <div id="map">
        </div>
        <div id="sidebar">
            <!-- Search Box -->
            <div class="search-card" style="margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <h3 style="font-size: 16px; margin-bottom: 10px; color: #2d3748;">üîç Cerca</h3>
                <input type="text" class="search-input" id="search-input" placeholder="Cerca un comune..." style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 14px;">
                <div class="search-results" id="search-results"></div>
            </div>

            <!-- Settings -->
            <div class="settings">
                <h3>‚öôÔ∏è Impostazioni</h3>
                <div class="settings-item">
                    <input type="checkbox" id="toggle-popup-labels" title="Mostra sempre i titoli dei presidi sulla mappa">
                    <label for="toggle-popup-labels">Mostra sempre titoli presidi</label>
                </div>
                <div class="settings-item" id="label-type-setting" style="display: none; padding-left: 24px;">
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="label-type-nome" name="label-type" value="nome" checked>
                            <label for="label-type-nome">Nome completo presidio</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="label-type-comune" name="label-type" value="comune">
                            <label for="label-type-comune">Solo comune/quartiere</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Map Type Selector -->
            <div class="settings">
                <h3>üó∫Ô∏è Tipo di Mappa</h3>
                <div class="map-type-buttons">
                    <button class="map-type-btn active" id="map-type-roadmap" title="Mappa stradale">
                        üõ£Ô∏è Stradale
                    </button>
                    <button class="map-type-btn" id="map-type-satellite" title="Mappa satellitare">
                        üõ∞Ô∏è Satellite
                    </button>
                    <button class="map-type-btn" id="map-type-hybrid" title="Mappa ibrida (satellite + etichette)">
                        üåç Ibrida
                    </button>
                    <button class="map-type-btn" id="map-type-terrain" title="Mappa terreno">
                        ‚õ∞Ô∏è Terreno
                    </button>
                </div>
            </div>

            <div class="legend">
                <h3>Legenda</h3>
                <div id="legend-content"></div>
            </div>

            <!-- Control Buttons -->
            <div class="control-section">
                <h3>üè• Gestione Presidi</h3>

                <!-- Print Options -->
                <div class="print-options">
                    <div class="print-options-title">üè∑Ô∏è Etichette Stampa:</div>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="label-nome" name="print-label" value="nome" checked>
                            <label for="label-nome">Nome Presidio</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="label-comune" name="print-label" value="comune">
                            <label for="label-comune">Comune/Quartiere</label>
                        </div>
                    </div>
                </div>

                <div class="control-buttons">
                    <button class="btn btn-save" id="btn-save" title="Salva lo stato corrente dei presidi">üíæ Salva</button>
                    <button class="btn btn-reset" id="btn-reset" title="Ripristina tutti i presidi">üîÑ Reset</button>
                    <button class="btn btn-print" id="btn-print" title="Stampa la mappa">üñ®Ô∏è Stampa</button>
                </div>

                <div class="control-buttons">
                    <button class="btn btn-export" id="btn-export" title="Esporta configurazione (stato presidi + presidi custom)">üì§ Esporta</button>
                    <button class="btn btn-import" id="btn-import" title="Importa configurazione">üì• Importa</button>
                </div>
            </div>

            <h2>Distretti e Comuni</h2>
            <div id="distretti-list"></div>
        </div>
    </div>

    <div id="info-box" class="info-box"></div>

    <!-- Context Menu -->
    <div id="context-menu" class="context-menu">
        <div class="context-menu-item edit" id="menu-edit">‚úèÔ∏è Modifica posizione</div>
        <div class="context-menu-item save" id="menu-save">üíæ Salva posizione</div>
        <div class="context-menu-item change-icon" id="menu-change-icon">üé® Cambia icona</div>
        <div class="context-menu-item measure" id="menu-measure">üìè Misura distanza</div>
        <div class="context-menu-item add" id="menu-add-presidio">‚ûï Aggiungi presidio</div>
        <div class="context-menu-item delete" id="menu-delete">üóëÔ∏è Elimina presidio</div>
    </div>

    <!-- Modal for adding custom presidio -->
    <div id="modal-add-presidio" class="modal">
        <div class="modal-content">
            <div class="modal-header">‚ûï Aggiungi nuovo presidio</div>
            <div class="modal-body">
                <label for="presidio-name-input" style="display: block; margin-bottom: 8px; color: #4a5568; font-size: 13px; font-weight: 500;">Nome del presidio:</label>
                <input type="text" id="presidio-name-input" class="modal-input" placeholder="Inserisci il nome del presidio...">
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" id="modal-cancel-btn">Annulla</button>
                <button class="modal-btn modal-btn-primary" id="modal-confirm-btn">Aggiungi</button>
            </div>
        </div>
    </div>

    <!-- Modal for changing presidio icon -->
    <div id="modal-change-icon" class="modal">
        <div class="modal-content">
            <div class="modal-header">üé® Seleziona icona presidio</div>
            <div class="modal-body">
                <div class="icon-grid">
                    <div class="icon-option" data-icon="hospital">
                        <div class="icon-option-emoji">üè•</div>
                        <div class="icon-option-label">Ospedale</div>
                    </div>
                    <div class="icon-option" data-icon="ambulance">
                        <div class="icon-option-emoji">üöë</div>
                        <div class="icon-option-label">Ambulanza</div>
                    </div>
                    <div class="icon-option" data-icon="cross">
                        <div class="icon-option-emoji">‚úö</div>
                        <div class="icon-option-label">Croce</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" id="modal-icon-cancel-btn">Annulla</button>
                <button class="modal-btn modal-btn-primary" id="modal-icon-confirm-btn">Conferma</button>
            </div>
        </div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="import-file-input" class="hidden-input" accept=".json">

    <!-- Copyright -->
    <div class="footer-copyright">
        ¬© Ing. Roberto De Domenico per ASP 5 Messina
    </div>

    <!-- Stats Badge -->
    <div class="stats-badge">
        <div class="stats-title">Stato Geolocalizzazione</div>
        <div class="stats-missing" id="stats-missing">Caricamento...</div>
        <div class="stats-success" id="stats-success"></div>
    </div>

    <!-- Toggle Legend Button -->
    <button class="toggle-legend-btn visible" id="toggle-legend-btn" title="Mostra legenda distretti">
        üìç
    </button>

    <!-- Distretti Legend Badge -->
    <div class="distretti-legend-badge hidden" id="distretti-legend-badge">
        <button class="close-btn" id="close-legend-btn" title="Nascondi legenda">√ó</button>
        <div class="legend-badge-title">üìç ID Distretti per URL</div>
        <div class="distretto-id-item">
            <span class="distretto-id-name">Barcellona P.G.</span>
            <span class="distretto-id-code">barcellona</span>
        </div>
        <div class="distretto-id-item">
            <span class="distretto-id-name">Lipari</span>
            <span class="distretto-id-code">lipari</span>
        </div>
        <div class="distretto-id-item">
            <span class="distretto-id-name">Messina</span>
            <span class="distretto-id-code">messina</span>
        </div>
        <div class="distretto-id-item">
            <span class="distretto-id-name">Milazzo</span>
            <span class="distretto-id-code">milazzo</span>
        </div>
        <div class="distretto-id-item">
            <span class="distretto-id-name">Mistretta</span>
            <span class="distretto-id-code">mistretta</span>
        </div>
        <div class="distretto-id-item">
            <span class="distretto-id-name">Patti</span>
            <span class="distretto-id-code">patti</span>
        </div>
        <div class="distretto-id-item">
            <span class="distretto-id-name">Sant'Agata di Militello</span>
            <span class="distretto-id-code">santagata</span>
        </div>
        <div class="distretto-id-item">
            <span class="distretto-id-name">Taormina</span>
            <span class="distretto-id-code">taormina</span>
        </div>
        <div class="legend-badge-hint">
            üí° Usa: ?distretto=<span style="color: #667eea; font-weight: 600;">nome</span>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Initialize BASE_PATH based on hostname
        let BASE_PATH = '';

        async function loadConfig() {
            const hostname = window.location.hostname;

            // Only load config from API if running on ws1.asp.messina.it
            if (hostname === 'ws1.asp.messina.it') {
                try {
                    console.log('Running on ws1.asp.messina.it, loading config...');
                    const response = await fetch('https://ws1.asp.messina.it/api/v1/apps/presidi-distretti-asp-messina/config');
                    if (response.ok) {
                        const config = await response.json();
                        BASE_PATH = config.data.basePath || '';
                        console.log('Config loaded, using BASE_PATH:', BASE_PATH);
                    }
                    else
                    {
                        console.error('Failed to load config, status:', response.status);
                        BASE_PATH = '';
                    }
                } catch (err) {
                    console.error('Error loading config from API:', err);
                    BASE_PATH = '';
                }
            } else {
                console.log('Not running on ws1.asp.messina.it, using empty BASE_PATH');
                BASE_PATH = '';
            }
        }

        // Mappatura nomi semplificati ‚Üí nomi ufficiali distretti
        const DISTRETTI_MAP = {
            'barcellona': 'Barcellona P.G.',
            'barcellonapg': 'Barcellona P.G.',
            'lipari': 'Lipari',
            'messina': 'Messina',
            'messinacitt√†': 'Messina',
            'messinacitta': 'Messina',
            'milazzo': 'Milazzo',
            'mistretta': 'Mistretta',
            'patti': 'Patti',
            'santagata': 'Sant\'Agata di Militello',
            'santagatadimilitello': 'Sant\'Agata di Militello',
            'santagatadimililitello': 'Sant\'Agata di Militello',
            'taormina': 'Taormina'
        };

        // Parse URL parameters
        function getURLParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // Normalize distretto name from URL
        function normalizeDistrettoName(input) {
            if (!input) return null;
            // Rimuovi spazi, punti, apostrofi e converti in lowercase
            const normalized = input.toLowerCase().replace(/[\s.']/g, '');
            return DISTRETTI_MAP[normalized] || null;
        }

        // Normalize string for comparison (handles different apostrophe types)
        function normalizeForComparison(str) {
            if (!str) return '';
            // Replace all types of apostrophes and normalize
            // U+0027 = straight apostrophe ('), U+2019 = right single quotation mark (')
            return str.toLowerCase().replace(/[\s.\u0027\u2019]/g, '');
        }

        // Find matching distretto name in array (handles apostrophe variations)
        function findMatchingDistretto(searchName, distrettiArray) {
            if (!searchName) return null;
            const normalizedSearch = normalizeForComparison(searchName);
            return distrettiArray.find(d => normalizeForComparison(d) === normalizedSearch);
        }

        async function initApp() {
            // Load configuration first
            await loadConfig();

            // Inizializza mappa
            const map = L.map('map').setView([38.19, 15.25], 10);

        // Definizione tile layers
        const tileLayers = {
            roadmap: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap contributors'
            }),
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                maxZoom: 19,
                attribution: '¬© Esri, Maxar, Earthstar Geographics'
            }),
            hybrid: L.layerGroup([
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    maxZoom: 19
                }),
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    opacity: 0.4
                })
            ]),
            terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                maxZoom: 17,
                attribution: '¬© OpenTopoMap contributors'
            })
        };

        // Carica preferenza salvata o usa roadmap
        let currentTileLayer = localStorage.getItem('map-type') || 'roadmap';
        if (!tileLayers[currentTileLayer]) currentTileLayer = 'roadmap';
        tileLayers[currentTileLayer].addTo(map);

        // Setup pulsanti cambio mappa
        function setupMapTypeButtons() {
            const buttons = {
                'map-type-roadmap': 'roadmap',
                'map-type-satellite': 'satellite',
                'map-type-hybrid': 'hybrid',
                'map-type-terrain': 'terrain'
            };

            // Imposta pulsante attivo iniziale
            document.querySelectorAll('.map-type-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = Object.keys(buttons).find(key => buttons[key] === currentTileLayer);
            if (activeBtn) document.getElementById(activeBtn)?.classList.add('active');

            Object.keys(buttons).forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.addEventListener('click', () => {
                        const newType = buttons[btnId];

                        // Rimuovi layer corrente
                        Object.values(tileLayers).forEach(layer => {
                            if (map.hasLayer(layer)) map.removeLayer(layer);
                        });

                        // Aggiungi nuovo layer
                        tileLayers[newType].addTo(map);
                        currentTileLayer = newType;

                        // Aggiorna pulsanti
                        document.querySelectorAll('.map-type-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');

                        // Salva preferenza
                        localStorage.setItem('map-type', newType);
                    });
                }
            });
        }
        setupMapTypeButtons();

        // Colori per i distretti
        const colors = [
            '#667eea', '#764ba2', '#f093fb', '#f5576c',
            '#4facfe', '#00f2fe', '#43e97b', '#38f9d7',
            '#fa709a', '#fee140', '#30cfd0', '#330867'
        ];

        const distrettiData = {};
        const distrettiLayers = {}; // Store layers by distretto for filtering
        const allFeatures = []; // Store all features for search
        const presidiMarkers = {}; // Store presidi markers by distretto
        const presidiCounts = {}; // Count presidi per distretto
        const presidiCountsByComune = {}; // Count presidi per comune
        const comuneFeatures = {}; // Store features by comune for zooming
        let selectedDistretto = null;
        let editingMarker = null; // Marker currently being edited
        const infoBox = document.getElementById('info-box');
        const contextMenu = document.getElementById('context-menu');
        const allPresidiMarkers = []; // Store all presidi markers for visibility control
        const presidiVisibility = {}; // Track visibility state of each presidio
        const presidiOriginalVisibility = {}; // Track original visibility from file/user choice
        const presidiLabels = {}; // Store labels for print
        const labelConnectorLines = {}; // Store connector lines for labels
        let comuneHoverTooltip = null; // Tooltip for comune hover

        // Distance measurement state
        let measuringDistance = false;
        let firstMeasurePoint = null;
        let distanceLine = null;
        let roadRouteLine = null;
        let distanceMarkers = [];

        // Custom presidi state
        const customPresidi = []; // Store custom presidi added by user
        let pendingPresidioPosition = null; // Store position for new presidio

        // Icon types and preferences
        const ICON_TYPES = {
            hospital: 'üè•',
            ambulance: 'üöë',
            cross: '‚úö'
        };
        const presidiIcons = {}; // Store icon type for each presidio (by nome)

        // Get icon HTML for a given type
        function getIconHTML(iconType = 'hospital') {
            const emoji = ICON_TYPES[iconType] || ICON_TYPES.hospital;
            return `<div style="font-size: 28px; text-align: center; line-height: 1; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));">${emoji}</div>`;
        }

        // Load and display statistics
        fetch(BASE_PATH + '/api/stats')
            .then(r => r.json())
            .then(stats => {
                const missingElement = document.getElementById('stats-missing');
                if (stats.missing === 0) {
                    // Hide missing count if all are geocoded
                    missingElement.style.display = 'none';
                } else {
                    missingElement.textContent =
                        `‚ùå ${stats.missing} presidi non geolocalizzati`;
                }
                document.getElementById('stats-success').textContent =
                    `‚úì ${stats.percentage}% geolocalizzati (${stats.geocoded}/${stats.total})`;
            })
            .catch(err => {
                console.error('Error loading stats:', err);
                document.getElementById('stats-missing').textContent = 'Errore caricamento';
            });

        // Carica i dati
        Promise.all([
            fetch(BASE_PATH + '/distretti-detailed.geojson').then(r => r.json()),
            fetch(BASE_PATH + '/presidi.geojson').then(r => r.json())
        ]).then(([detailedData, presidiData]) => {
            console.log('Dati caricati:', detailedData, presidiData);

            // Raggruppa per distretto
            detailedData.features.forEach(feature => {
                const distretto = feature.properties.distretto;
                if (!distrettiData[distretto]) {
                    distrettiData[distretto] = {
                        features: [],
                        comuni: new Set()
                    };
                }
                distrettiData[distretto].features.push(feature);

                if (feature.properties.comune) {
                    distrettiData[distretto].comuni.add(feature.properties.comune);
                }
            });

            // Crea layer per ogni distretto
            const distrettiNames = Object.keys(distrettiData).sort();

            distrettiNames.forEach((distretto, index) => {
                const color = colors[index % colors.length];
                const data = distrettiData[distretto];

                // Initialize layer group for this distretto
                distrettiLayers[distretto] = {
                    layers: [],
                    color: color,
                    visible: true
                };

                data.features.forEach(feature => {
                    const comune = feature.properties.comune;

                    // Store feature with distretto info for search
                    allFeatures.push({
                        comune: comune,
                        distretto: distretto,
                        feature: feature,
                        color: color
                    });

                    // Store feature by comune for zooming
                    if (!comuneFeatures[comune]) {
                        comuneFeatures[comune] = [];
                    }
                    comuneFeatures[comune].push(feature);

                    const layer = L.geoJSON(feature, {
                        style: {
                            fillColor: color,
                            weight: 1,
                            opacity: 1,
                            color: 'white',
                            fillOpacity: 0.5
                        }
                    });

                    layer.on('mouseover', function(e) {
                        e.target.setStyle({
                            fillOpacity: 0.8,
                            weight: 2
                        });

                        const comune = feature.properties.comune;
                        infoBox.innerHTML = `
                            <h3>${distretto}</h3>
                            <p><strong>Comune:</strong> ${comune}</p>
                        `;
                        infoBox.classList.add('show');

                        // Show comune name on map
                        if (comuneHoverTooltip) {
                            map.closeTooltip(comuneHoverTooltip);
                        }

                        // Get center of polygon bounds
                        const bounds = e.target.getBounds();
                        const center = bounds.getCenter();

                        comuneHoverTooltip = L.tooltip({
                            permanent: true,
                            direction: 'center',
                            className: 'comune-hover-tooltip',
                            offset: [0, 0]
                        })
                        .setLatLng(center)
                        .setContent(comune)
                        .addTo(map);
                    });

                    layer.on('mousemove', function(e) {
                        // Update tooltip position to follow mouse
                        if (comuneHoverTooltip) {
                            comuneHoverTooltip.setLatLng(e.latlng);
                        }
                    });

                    layer.on('mouseout', function(e) {
                        if (selectedDistretto !== distretto) {
                            e.target.setStyle({
                                fillOpacity: 0.5,
                                weight: 1
                            });
                        }
                        infoBox.classList.remove('show');

                        // Hide comune tooltip
                        if (comuneHoverTooltip) {
                            map.removeLayer(comuneHoverTooltip);
                            comuneHoverTooltip = null;
                        }
                    });

                    layer.on('click', function(e) {
                        selectedDistretto = distretto;

                        // Mostra popup
                        const comuniArray = Array.from(data.comuni).sort();
                        const popupContent = `
                            <div class="popup-title">${distretto}</div>
                            <div class="popup-text">
                                <strong>Comuni (${comuniArray.length}):</strong><br>
                                ${comuniArray.join(', ')}
                            </div>
                        `;

                        L.popup()
                            .setLatLng(e.latlng)
                            .setContent(popupContent)
                            .openOn(map);
                    });

                    layer.addTo(map);
                    distrettiLayers[distretto].layers.push(layer);
                });
            });

            // Create map of presidi by comune
            const presidiByComune = {};
            presidiData.features.forEach(presidio => {
                const distretto = presidio.properties.distretto;
                const comune = presidio.properties.comune;

                if (distretto) {
                    presidiCounts[distretto] = (presidiCounts[distretto] || 0) + 1;
                }

                if (comune) {
                    presidiCountsByComune[comune] = (presidiCountsByComune[comune] || 0) + 1;
                    if (!presidiByComune[comune]) {
                        presidiByComune[comune] = [];
                    }
                    presidiByComune[comune].push(presidio);
                }
            });

            // Helper function to update tooltip content based on label type
            function updateTooltipContent(marker) {
                const labelType = document.querySelector('input[name="label-type"]:checked').value;
                const content = labelType === 'comune'
                    ? (marker.tooltipContent.comune || marker.tooltipContent.nome)
                    : marker.tooltipContent.nome;
                marker.setTooltipContent(content);
            }

            // Helper function to check if tooltips should be shown based on zoom
            function shouldShowTooltips() {
                // Always show tooltips, but adjust size/opacity based on zoom
                return true;
            }

            // Calculate font size based on zoom level
            function calculateTooltipFontSize(zoom) {
                if (zoom <= 10) {
                    return Math.max(8, 6 + zoom * 0.4);
                } else if (zoom <= 13) {
                    return 10 + (zoom - 10) * 1;
                } else {
                    return Math.min(16, 13 + (zoom - 13) * 0.5);
                }
            }

            // Check collision between two bounding boxes
            function checkCollision(bounds1, bounds2) {
                if (!bounds1 || !bounds2) return false;
                const padding = 5;
                return !(
                    bounds1.right + padding < bounds2.left ||
                    bounds1.left - padding > bounds2.right ||
                    bounds1.bottom + padding < bounds2.top ||
                    bounds1.top - padding > bounds2.bottom
                );
            }

            // Resolve tooltip collisions
            function resolveTooltipCollisions() {
                // Get visible markers with tooltips
                const visibleMarkers = allPresidiMarkers.filter(m =>
                    presidiVisibility[m.nome] !== false && m.marker.getTooltip()
                );

                if (visibleMarkers.length < 2) return;

                // Initialize offsets if not exists
                visibleMarkers.forEach(markerData => {
                    const marker = markerData.marker;
                    if (!marker.tooltipCollisionOffset) {
                        marker.tooltipCollisionOffset = [0, 0];
                    }

                    // Remove connector line if exists
                    if (labelConnectorLines[markerData.nome]) {
                        map.removeLayer(labelConnectorLines[markerData.nome]);
                        delete labelConnectorLines[markerData.nome];
                    }
                });

                // Force redraw
                setTimeout(() => {
                    const maxIterations = 3; // Limit iterations
                    const maxTotalOffset = 50; // Maximum total offset from original position

                    // Reset all collision offsets
                    visibleMarkers.forEach(m => {
                        m.marker.tooltipCollisionOffset = [0, 0];
                    });

                    for (let iteration = 0; iteration < maxIterations; iteration++) {
                        let hasCollision = false;

                        for (let i = 0; i < visibleMarkers.length; i++) {
                            const marker1 = visibleMarkers[i].marker;
                            const tooltip1 = marker1.getTooltip();
                            if (!tooltip1) continue;
                            const elem1 = tooltip1.getElement();
                            if (!elem1) continue;

                            // Remove transform temporarily to get base bounds
                            const transform1 = elem1.style.transform;
                            elem1.style.transform = '';
                            const baseBounds1 = elem1.getBoundingClientRect();
                            elem1.style.transform = transform1;

                            // Apply current collision offset to bounds
                            const collOffset1 = marker1.tooltipCollisionOffset;
                            const bounds1 = {
                                left: baseBounds1.left + collOffset1[0],
                                right: baseBounds1.right + collOffset1[0],
                                top: baseBounds1.top + collOffset1[1],
                                bottom: baseBounds1.bottom + collOffset1[1],
                                width: baseBounds1.width,
                                height: baseBounds1.height
                            };

                            for (let j = i + 1; j < visibleMarkers.length; j++) {
                                const marker2 = visibleMarkers[j].marker;
                                const tooltip2 = marker2.getTooltip();
                                if (!tooltip2) continue;
                                const elem2 = tooltip2.getElement();
                                if (!elem2) continue;

                                // Remove transform temporarily to get base bounds
                                const transform2 = elem2.style.transform;
                                elem2.style.transform = '';
                                const baseBounds2 = elem2.getBoundingClientRect();
                                elem2.style.transform = transform2;

                                // Apply current collision offset to bounds
                                const collOffset2 = marker2.tooltipCollisionOffset;
                                const bounds2 = {
                                    left: baseBounds2.left + collOffset2[0],
                                    right: baseBounds2.right + collOffset2[0],
                                    top: baseBounds2.top + collOffset2[1],
                                    bottom: baseBounds2.bottom + collOffset2[1],
                                    width: baseBounds2.width,
                                    height: baseBounds2.height
                                };

                                if (checkCollision(bounds1, bounds2)) {
                                    hasCollision = true;

                                    // Calculate movement direction
                                    const pos1 = map.latLngToContainerPoint(marker1.getLatLng());
                                    const pos2 = map.latLngToContainerPoint(marker2.getLatLng());
                                    const dx = pos2.x - pos1.x;
                                    const dy = pos2.y - pos1.y;

                                    if (Math.abs(dx) === 0 && Math.abs(dy) === 0) continue;

                                    const overlapX = (bounds1.width + bounds2.width) / 2 - Math.abs(dx);
                                    const overlapY = (bounds1.height + bounds2.height) / 2 - Math.abs(dy);
                                    let moveAmount = Math.max(overlapX, overlapY) / 2 + 3;

                                    // Limit maximum movement to avoid labels going too far
                                    const maxMove = 25; // Maximum pixels to move in one iteration
                                    moveAmount = Math.min(moveAmount, maxMove);

                                    // Move tooltips apart using collision offsets
                                    if (Math.abs(dx) > Math.abs(dy)) {
                                        // Move horizontally
                                        if (dx > 0) {
                                            marker1.tooltipCollisionOffset[0] -= moveAmount;
                                            marker2.tooltipCollisionOffset[0] += moveAmount;
                                        } else {
                                            marker1.tooltipCollisionOffset[0] += moveAmount;
                                            marker2.tooltipCollisionOffset[0] -= moveAmount;
                                        }
                                    } else {
                                        // Move vertically
                                        if (dy > 0) {
                                            marker1.tooltipCollisionOffset[1] -= moveAmount;
                                            marker2.tooltipCollisionOffset[1] += moveAmount;
                                        } else {
                                            marker1.tooltipCollisionOffset[1] += moveAmount;
                                            marker2.tooltipCollisionOffset[1] -= moveAmount;
                                        }
                                    }
                                }
                            }
                        }

                        if (!hasCollision) break;
                    }

                    // Apply all collision offsets via CSS transform
                    visibleMarkers.forEach(markerData => {
                        const marker = markerData.marker;
                        const tooltip = marker.getTooltip();
                        if (!tooltip) return;
                        const elem = tooltip.getElement();
                        if (!elem) return;

                        const collisionOffset = marker.tooltipCollisionOffset;
                        const distance = Math.sqrt(
                            collisionOffset[0] * collisionOffset[0] +
                            collisionOffset[1] * collisionOffset[1]
                        );

                        // Apply transform only if within limits
                        if (distance <= maxTotalOffset) {
                            elem.style.transform = `translate(${collisionOffset[0]}px, ${collisionOffset[1]}px)`;
                        } else {
                            // Clamp to maximum
                            const scale = maxTotalOffset / distance;
                            const clampedX = collisionOffset[0] * scale;
                            const clampedY = collisionOffset[1] * scale;
                            elem.style.transform = `translate(${clampedX}px, ${clampedY}px)`;
                        }
                    });

                    // Add connector lines for labels that moved far from their markers
                    visibleMarkers.forEach(markerData => {
                        const marker = markerData.marker;
                        const collisionOffset = marker.tooltipCollisionOffset;
                        const distance = Math.sqrt(
                            collisionOffset[0] * collisionOffset[0] +
                            collisionOffset[1] * collisionOffset[1]
                        );

                        // Show connector line only if moved significantly (>50px)
                        if (distance > 50) {
                            const markerLatLng = marker.getLatLng();
                            const markerPoint = map.latLngToContainerPoint(markerLatLng);
                            const origOffset = marker.tooltipOriginalOffset;
                            const labelPoint = {
                                x: markerPoint.x + origOffset[0] + collisionOffset[0],
                                y: markerPoint.y + origOffset[1] + collisionOffset[1]
                            };
                            const labelLatLng = map.containerPointToLatLng(labelPoint);

                            const line = L.polyline([markerLatLng, labelLatLng], {
                                color: '#666666',
                                weight: 1,
                                opacity: 0.5,
                                dashArray: '4, 4',
                                interactive: false
                            }).addTo(map);

                            labelConnectorLines[markerData.nome] = line;
                        }
                    });

                    // Hide some labels at low zoom if too crowded
                    const currentZoom = map.getZoom();
                    if (currentZoom < 10 && visibleMarkers.length > 30) {
                        // At very low zoom, show only every 4th label
                        visibleMarkers.forEach((markerData, index) => {
                            if (index % 4 !== 0) {
                                markerData.marker.closeTooltip();
                            }
                        });
                    } else if (currentZoom < 11 && visibleMarkers.length > 50) {
                        // At low zoom, show only every 3rd label
                        visibleMarkers.forEach((markerData, index) => {
                            if (index % 3 !== 0) {
                                markerData.marker.closeTooltip();
                            }
                        });
                    } else if (currentZoom < 12 && visibleMarkers.length > 80) {
                        // At medium zoom with many labels, show every other one
                        visibleMarkers.forEach((markerData, index) => {
                            if (index % 2 !== 0) {
                                markerData.marker.closeTooltip();
                            }
                        });
                    }
                }, 50);
            }

            // Helper function to determine label text based on zoom and density
            function getLabelText(markerData, zoom) {
                const comune = markerData.comune || '';
                const nome = markerData.nome || '';

                // Check if user has explicitly changed the label type setting
                const labelTypeRadio = document.querySelector('input[name="label-type"]:checked');
                const labelType = labelTypeRadio ? labelTypeRadio.value : 'nome';

                // Check if the setting was explicitly changed by user (not just default)
                const wasExplicitlyChanged = labelTypeRadio && labelTypeRadio.dataset.userChanged === 'true';

                // If user explicitly chose a preference, always respect it
                if (wasExplicitlyChanged) {
                    if (labelType === 'nome') {
                        return nome;
                    } else if (labelType === 'comune') {
                        return comune;
                    }
                }

                // Default behavior based on zoom (automatic mode)
                // At low zoom (< 12), show only comune
                if (zoom < 12) {
                    return comune;
                }
                // At medium zoom (12-13), show comune if name is too long
                else if (zoom < 13) {
                    return nome.length > 30 ? comune : nome;
                }
                // At high zoom (13+), always show full name
                else {
                    return nome;
                }
            }

            // Helper function to update all tooltips visibility
            function updateAllTooltips() {
                const currentZoom = map.getZoom();
                const fontSize = calculateTooltipFontSize(currentZoom);

                allPresidiMarkers.forEach(markerData => {
                    const marker = markerData.marker;
                    // Only show tooltip if marker is visible
                    if (presidiVisibility[markerData.nome] !== false) {
                        // Set appropriate label text based on zoom
                        const labelText = getLabelText(markerData, currentZoom);
                        marker.setTooltipContent(labelText);
                        marker.openTooltip();

                        // Update font size dynamically
                        const tooltipElement = marker.getTooltip().getElement();
                        if (tooltipElement) {
                            tooltipElement.style.fontSize = fontSize + 'px';
                            tooltipElement.style.opacity = currentZoom < 11 ? '0.7' : '1';
                        }
                    } else {
                        marker.closeTooltip();
                    }
                });

                // Collision detection disabled for now to avoid label drift
                // setTimeout(() => resolveTooltipCollisions(), 100);
            }

            // Check for URL parameter to filter by distretto
            const urlDistrettoParam = getURLParameter('distretto');
            let filteredDistretto = null;

            if (urlDistrettoParam) {
                const mappedDistretto = normalizeDistrettoName(urlDistrettoParam);
                // Find actual distretto name (handles apostrophe variations)
                filteredDistretto = findMatchingDistretto(mappedDistretto, distrettiNames);

                if (filteredDistretto) {
                    console.log(`Filtro distretto attivato: ${filteredDistretto} (da parametro: ${urlDistrettoParam})`);

                    // Hide all distretti except the filtered one
                    distrettiNames.forEach(distretto => {
                        if (normalizeForComparison(distretto) !== normalizeForComparison(filteredDistretto)) {
                            distrettiLayers[distretto].visible = false;
                            // Hide all layers for this distretto
                            distrettiLayers[distretto].layers.forEach(layer => {
                                map.removeLayer(layer);
                            });
                        }
                    });
                } else if (urlDistrettoParam) {
                    console.warn(`Distretto non valido: ${urlDistrettoParam}`);
                    alert(`‚ö†Ô∏è Distretto "${urlDistrettoParam}" non trovato. Distretti validi: ${distrettiNames.join(', ')}`);
                }
            }

            // Popola sidebar
            const legendContent = document.getElementById('legend-content');
            const distrettiList = document.getElementById('distretti-list');

            distrettiNames.forEach((distretto, index) => {
                const color = colors[index % colors.length];
                const data = distrettiData[distretto];
                const comuniArray = Array.from(data.comuni).sort();

                // Aggiungi alla legenda con checkbox
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                const safeDistrettoIdLegend = distretto.replace(/[\s.]+/g, '-');
                const checkboxId = `checkbox-${safeDistrettoIdLegend}`;
                const isChecked = distrettiLayers[distretto].visible;
                legendItem.innerHTML = `
                    <input type="checkbox" id="${checkboxId}" ${isChecked ? 'checked' : ''}>
                    <label for="${checkboxId}">
                        <div class="legend-color" style="background-color: ${color}"></div>
                        <span>${distretto}</span>
                    </label>
                `;
                legendContent.appendChild(legendItem);

                // Add event listener for checkbox
                const checkbox = legendItem.querySelector('input[type="checkbox"]');
                checkbox.addEventListener('change', function() {
                    const visible = this.checked;
                    distrettiLayers[distretto].visible = visible;
                    const showLabels = document.getElementById('toggle-popup-labels').checked;

                    // Show or hide all layers for this distretto
                    distrettiLayers[distretto].layers.forEach(layer => {
                        if (visible) {
                            map.addLayer(layer);
                        } else {
                            map.removeLayer(layer);
                        }
                    });

                    // Show or hide all presidi markers for this distretto
                    if (presidiMarkers[distretto]) {
                        presidiMarkers[distretto].forEach(marker => {
                            const markerData = allPresidiMarkers.find(md => md.marker === marker);
                            if (markerData) {
                                if (visible) {
                                    // When showing distretto, restore original visibility state for each presidio
                                    const shouldShow = presidiOriginalVisibility[markerData.nome] !== false;
                                    presidiVisibility[markerData.nome] = shouldShow;
                                    if (shouldShow) {
                                        map.addLayer(marker);
                                        // If permanent labels are enabled and zoom is sufficient, show tooltip
                                        if (shouldShowTooltips()) {
                                            updateTooltipContent(marker);
                                            marker.openTooltip();
                                        }
                                    }
                                    // Update checkbox in presidi list to reflect original state
                                    const checkbox = document.getElementById(`presidio-${markerData.id}`);
                                    if (checkbox) checkbox.checked = shouldShow;
                                } else {
                                    // When hiding distretto, hide all presidi
                                    presidiVisibility[markerData.nome] = false;
                                    marker.closeTooltip();
                                    map.removeLayer(marker);
                                    // Update checkbox in presidi list
                                    const checkbox = document.getElementById(`presidio-${markerData.id}`);
                                    if (checkbox) checkbox.checked = false;
                                }
                            }
                        });
                    }
                });

                // Aggiungi alla lista distretti
                const distrettoInfo = document.createElement('div');
                distrettoInfo.className = 'distretto-info';
                const safeDistrettoId = distretto.replace(/[\s.]+/g, '-');
                const toggleCheckboxId = `toggle-presidi-${safeDistrettoId}`;
                const isDistrettoChecked = distrettiLayers[distretto].visible;
                distrettoInfo.innerHTML = `
                    <div class="distretto-name" style="color: ${color}">
                        <input type="checkbox" id="${toggleCheckboxId}" ${isDistrettoChecked ? 'checked' : ''} title="Mostra/nascondi presidi del distretto">
                        <label for="${toggleCheckboxId}">${distretto}</label>
                    </div>
                    <ul class="comuni-list" id="comuni-list-${safeDistrettoId}">
                    </ul>
                `;
                distrettiList.appendChild(distrettoInfo);

                // Add event listener for toggle presidi checkbox
                const toggleCheckbox = document.getElementById(toggleCheckboxId);
                toggleCheckbox.addEventListener('change', function() {
                    const visible = this.checked;
                    // Show/hide all presidi markers for this distretto
                    if (presidiMarkers[distretto]) {
                        presidiMarkers[distretto].forEach(marker => {
                            const markerData = allPresidiMarkers.find(md => md.marker === marker);
                            if (markerData) {
                                presidiVisibility[markerData.nome] = visible;
                                if (visible) {
                                    map.addLayer(marker);
                                    // If permanent labels are enabled and zoom is sufficient, show tooltip
                                    if (shouldShowTooltips()) {
                                        updateTooltipContent(marker);
                                        marker.openTooltip();
                                    }
                                } else {
                                    marker.closeTooltip();
                                    map.removeLayer(marker);
                                }
                                // Update checkbox in presidi list
                                const checkbox = document.getElementById(`presidio-${markerData.id}`);
                                if (checkbox) checkbox.checked = visible;
                            }
                        });
                    }
                });

                // Add comuni with presidio counts and click handlers
                const comuniList = distrettoInfo.querySelector('.comuni-list');
                comuniArray.forEach(comune => {
                    const count = presidiCountsByComune[comune] || 0;
                    const li = document.createElement('li');

                    const comuneSpan = document.createElement('span');
                    comuneSpan.textContent = comune;
                    comuneSpan.style.cursor = 'pointer';
                    li.appendChild(comuneSpan);

                    if (count > 0) {
                        const countBadge = document.createElement('span');
                        countBadge.className = 'comune-presidio-count';
                        countBadge.textContent = `${count} üè•`;
                        li.appendChild(countBadge);
                    }

                    // Add click handler to zoom to comune (solo sul nome)
                    comuneSpan.addEventListener('click', function(e) {
                        e.stopPropagation();
                        if (comuneFeatures[comune] && comuneFeatures[comune].length > 0) {
                            // Create temporary layer to get bounds
                            const tempLayer = L.geoJSON({
                                type: 'FeatureCollection',
                                features: comuneFeatures[comune]
                            });
                            const bounds = tempLayer.getBounds();

                            // Zoom to comune
                            map.fitBounds(bounds, {
                                padding: [50, 50],
                                maxZoom: 13
                            });

                            // Show popup
                            const center = bounds.getCenter();
                            L.popup()
                                .setLatLng(center)
                                .setContent(`
                                    <div class="popup-title">${comune}</div>
                                    <div class="popup-text">
                                        <strong>Distretto:</strong> ${distretto}<br>
                                        ${count > 0 ? `<strong>Presidi:</strong> ${count}` : ''}
                                    </div>
                                `)
                                .openOn(map);
                        }
                    });

                    // Store li element for later (when we add presidi)
                    li.dataset.comune = comune;
                    comuniList.appendChild(li);
                });
            });

            // Fit bounds
            const bounds = L.geoJSON(detailedData).getBounds();
            map.fitBounds(bounds, { padding: [20, 20] });

            // Setup search functionality
            const searchInput = document.getElementById('search-input');
            const searchResults = document.getElementById('search-results');
            let currentHighlight = null;

            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase().trim();
                searchResults.innerHTML = '';

                if (searchTerm.length < 2) {
                    return;
                }

                // Search through all features
                const matches = allFeatures.filter(item =>
                    item.comune.toLowerCase().includes(searchTerm)
                ).slice(0, 10); // Limit to 10 results

                if (matches.length === 0) {
                    searchResults.innerHTML = '<div class="search-no-results">Nessun comune trovato</div>';
                    return;
                }

                matches.forEach(match => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    resultItem.innerHTML = `
                        <div class="search-result-comune">${match.comune}</div>
                        <div class="search-result-distretto">Distretto: ${match.distretto}</div>
                    `;

                    resultItem.addEventListener('click', function() {
                        // Get bounds of the feature
                        const featureLayer = L.geoJSON(match.feature);
                        const featureBounds = featureLayer.getBounds();

                        // Zoom to feature
                        map.fitBounds(featureBounds, {
                            padding: [50, 50],
                            maxZoom: 13
                        });

                        // Remove previous highlight
                        if (currentHighlight) {
                            map.removeLayer(currentHighlight);
                        }

                        // Highlight the feature
                        currentHighlight = L.geoJSON(match.feature, {
                            style: {
                                fillColor: match.color,
                                weight: 3,
                                opacity: 1,
                                color: '#ff6b6b',
                                fillOpacity: 0.7
                            }
                        }).addTo(map);

                        // Show popup
                        const center = featureBounds.getCenter();
                        L.popup()
                            .setLatLng(center)
                            .setContent(`
                                <div class="popup-title">${match.comune}</div>
                                <div class="popup-text">
                                    <strong>Distretto:</strong> ${match.distretto}
                                </div>
                            `)
                            .openOn(map);

                        // Clear search
                        searchInput.value = '';
                        searchResults.innerHTML = '';

                        // Remove highlight after 5 seconds
                        setTimeout(() => {
                            if (currentHighlight) {
                                map.removeLayer(currentHighlight);
                                currentHighlight = null;
                            }
                        }, 5000);
                    });

                    searchResults.appendChild(resultItem);
                });
            });

            // Load visibility state from localStorage
            function loadPresidiVisibility() {
                try {
                    const saved = localStorage.getItem('presidi-visibility');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        Object.assign(presidiVisibility, parsed);
                        console.log('Stato presidi caricato da localStorage');
                    }
                } catch (error) {
                    console.error('Errore nel caricamento dello stato:', error);
                }
            }

            // Save visibility state to localStorage
            function savePresidiVisibility() {
                try {
                    localStorage.setItem('presidi-visibility', JSON.stringify(presidiVisibility));
                    alert('‚úì Stato presidi salvato con successo!');
                    console.log('Stato presidi salvato in localStorage');
                } catch (error) {
                    console.error('Errore nel salvataggio dello stato:', error);
                    alert('‚úó Errore nel salvataggio dello stato');
                }
            }

            // Reset visibility state
            function resetPresidiVisibility() {
                if (confirm('Sei sicuro di voler ripristinare lo stato iniziale? Tutti i presidi saranno nuovamente visibili.')) {
                    try {
                        localStorage.removeItem('presidi-visibility');
                        // Reset all to visible
                        allPresidiMarkers.forEach(markerData => {
                            presidiVisibility[markerData.nome] = true;
                            map.addLayer(markerData.marker);
                            // If permanent labels are enabled and zoom is sufficient, show tooltip
                            if (shouldShowTooltips()) {
                                updateTooltipContent(markerData.marker);
                                markerData.marker.openTooltip();
                            }
                            // Update checkbox
                            const checkbox = document.getElementById(`presidio-${markerData.id}`);
                            if (checkbox) checkbox.checked = true;
                        });
                        alert('‚úì Stato ripristinato! Tutti i presidi sono ora visibili.');
                        console.log('Stato presidi ripristinato');
                    } catch (error) {
                        console.error('Errore nel reset dello stato:', error);
                        alert('‚úó Errore nel reset dello stato');
                    }
                }
            }

            // Load saved state
            loadPresidiVisibility();

            // Load icon preferences
            function loadPresidiIcons() {
                try {
                    const saved = localStorage.getItem('presidi-icons');
                    if (saved) {
                        Object.assign(presidiIcons, JSON.parse(saved));
                        console.log('Preferenze icone caricate da localStorage');
                    }
                } catch (error) {
                    console.error('Errore nel caricamento preferenze icone:', error);
                }
            }

            function savePresidiIcons() {
                try {
                    localStorage.setItem('presidi-icons', JSON.stringify(presidiIcons));
                    console.log('Preferenze icone salvate in localStorage');
                } catch (error) {
                    console.error('Errore nel salvataggio preferenze icone:', error);
                }
            }

            loadPresidiIcons();

            // Load and display presidi
            console.log(`Caricamento ${presidiData.features.length} presidi...`);

            // Add presidi markers
            presidiData.features.forEach((presidio, index) => {
                const [lon, lat] = presidio.geometry.coordinates;
                const distretto = presidio.properties.distretto;
                const nome = presidio.properties.nome;
                const indirizzo = presidio.properties.indirizzo;
                const comune = presidio.properties.comune;

                // Get icon type for this presidio (default: hospital)
                const iconType = presidiIcons[nome] || 'hospital';

                // Create custom marker icon
                const presidioIcon = L.divIcon({
                    className: 'presidio-marker',
                    html: getIconHTML(iconType),
                    iconSize: [28, 28],
                    iconAnchor: [14, 14]
                });

                const marker = L.marker([lat, lon], {
                    icon: presidioIcon,
                    draggable: false
                }).addTo(map);

                marker.presidioData = {
                    nome: nome,
                    indirizzo: indirizzo,
                    distretto: distretto,
                    comune: comune
                };

                // Store popup content for reuse
                const popupContent = `
                    <div class="popup-title">${nome}</div>
                    <div class="popup-text">
                        <strong>Indirizzo:</strong> ${indirizzo}<br>
                        ${distretto ? `<strong>Distretto:</strong> ${distretto}<br>` : ''}
                        ${comune ? `<strong>Comune:</strong> ${comune}` : ''}
                    </div>
                `;

                // Popup on click (default behavior)
                marker.on('click', function(e) {
                    // Check if we're measuring distance
                    const distanceMeasured = handlePresidioClickForDistance(marker, e.latlng, nome);

                    // Only show normal popup if not measuring distance
                    if (!distanceMeasured) {
                        L.popup()
                            .setLatLng(e.latlng)
                            .setContent(popupContent)
                            .openOn(map);
                    }
                });

                // Bind permanent tooltip (always visible with nome)
                marker.tooltipContent = {
                    nome: nome,
                    comune: comune
                };

                // Alternate label direction based on index to reduce overlaps
                const directions = ['right', 'top', 'bottom', 'left'];
                const offsets = {
                    'right': [15, -10],
                    'top': [0, -15],
                    'bottom': [0, 15],
                    'left': [-15, -10]
                };
                const direction = directions[index % 4];
                const offset = offsets[direction];

                marker.bindTooltip(nome, {
                    permanent: true,
                    direction: direction,
                    offset: offset,
                    className: 'presidio-permanent-tooltip',
                    opacity: 0.95
                });
                marker.openTooltip(); // Keep tooltip visible

                // Store original offset
                marker.tooltipOriginalOffset = offset;
                marker.tooltipCurrentOffset = offset;

                // Right-click for context menu
                marker.on('contextmenu', function(e) {
                    L.DomEvent.preventDefault(e);

                    editingMarker = marker;
                    pendingPresidioPosition = null; // Clear pending position

                    // Position context menu
                    const x = e.originalEvent.pageX;
                    const y = e.originalEvent.pageY;

                    contextMenu.style.left = x + 'px';
                    contextMenu.style.top = y + 'px';
                    contextMenu.classList.add('show');

                    // Hide "Add presidio" option for marker context menu
                    document.getElementById('menu-add-presidio').style.display = 'none';

                    // Update menu based on draggable state
                    if (marker.options.draggable) {
                        document.getElementById('menu-edit').style.display = 'none';
                        document.getElementById('menu-save').style.display = 'block';
                        document.getElementById('menu-change-icon').style.display = 'none';
                        document.getElementById('menu-measure').style.display = 'none';
                    } else {
                        document.getElementById('menu-edit').style.display = 'block';
                        document.getElementById('menu-save').style.display = 'none';
                        document.getElementById('menu-change-icon').style.display = 'block';
                        document.getElementById('menu-measure').style.display = 'block';
                    }
                });

                // Create label for print
                const labelDiv = document.createElement('div');
                labelDiv.className = 'presidio-label';
                labelDiv.textContent = nome;
                labelDiv.style.left = '0px';
                labelDiv.style.top = '0px';
                document.body.appendChild(labelDiv);

                // Store marker with visibility data
                const markerData = {
                    id: index,
                    marker: marker,
                    nome: nome,
                    distretto: distretto,
                    comune: comune,
                    lat: lat,
                    lon: lon,
                    labelDiv: labelDiv  // Store reference to label
                };
                allPresidiMarkers.push(markerData);
                presidiLabels[nome] = markerData;  // Store full markerData instead of just label

                // Initialize visibility (default true or from saved state)
                if (presidiVisibility[nome] === undefined) {
                    presidiVisibility[nome] = true;
                }

                // Store original visibility state from file
                presidiOriginalVisibility[nome] = presidiVisibility[nome];

                // Apply saved visibility state
                if (presidiVisibility[nome] === false) {
                    map.removeLayer(marker);
                }

                if (distretto) {
                    if (!presidiMarkers[distretto]) {
                        presidiMarkers[distretto] = [];
                    }
                    presidiMarkers[distretto].push(marker);
                }
            });

            // Now add presidi checkboxes under each comune (after all markers are created)
            distrettiNames.forEach((distretto) => {
                const distrettoData = distrettiData[distretto];
                const comuniArray = Array.from(distrettoData.comuni).sort();

                comuniArray.forEach(comune => {
                    // Find the li element for this comune
                    const safeDistrettoIdForList = distretto.replace(/[\s.]+/g, '-');
                    const comuniListId = `comuni-list-${safeDistrettoIdForList}`;
                    const comuniList = document.getElementById(comuniListId);
                    if (!comuniList) return;

                    // Find the li for this specific comune
                    const comuneLi = Array.from(comuniList.querySelectorAll('li')).find(
                        li => li.dataset.comune === comune && !li.classList.contains('presidio-item')
                    );
                    if (!comuneLi) return;

                    // Add presidi list under comune if there are any
                    if (presidiByComune[comune] && presidiByComune[comune].length > 0) {
                        const presidiListUl = document.createElement('ul');
                        presidiListUl.className = 'presidi-comune-list';

                        presidiByComune[comune].forEach(presidioFeature => {
                            const presidioNome = presidioFeature.properties.nome;
                            const presidioMarkerData = allPresidiMarkers.find(md => md.nome === presidioNome);

                            if (presidioMarkerData) {
                                const presidioLi = document.createElement('li');
                                presidioLi.className = 'presidio-item';

                                const checkboxId = `presidio-${presidioMarkerData.id}`;
                                const isVisible = presidiVisibility[presidioNome] !== false;

                                const checkbox = document.createElement('input');
                                checkbox.type = 'checkbox';
                                checkbox.id = checkboxId;
                                checkbox.checked = isVisible;

                                const label = document.createElement('label');
                                label.htmlFor = checkboxId;
                                label.textContent = presidioNome;
                                label.title = presidioNome;

                                checkbox.addEventListener('change', function() {
                                    const visible = this.checked;
                                    presidiVisibility[presidioNome] = visible;
                                    // Update original visibility when user manually changes it
                                    presidiOriginalVisibility[presidioNome] = visible;

                                    if (visible) {
                                        map.addLayer(presidioMarkerData.marker);
                                        // If permanent labels are enabled and zoom is sufficient, show tooltip
                                        if (shouldShowTooltips()) {
                                            updateTooltipContent(presidioMarkerData.marker);
                                            presidioMarkerData.marker.openTooltip();
                                        }
                                    } else {
                                        presidioMarkerData.marker.closeTooltip();
                                        map.removeLayer(presidioMarkerData.marker);
                                    }
                                });

                                presidioLi.appendChild(checkbox);
                                presidioLi.appendChild(label);
                                presidiListUl.appendChild(presidioLi);
                            }
                        });

                        // Insert after the comune li
                        comuneLi.parentNode.insertBefore(presidiListUl, comuneLi.nextSibling);
                    }
                });
            });

            // Update legend with presidio counts
            distrettiNames.forEach((distretto, index) => {
                const count = presidiCounts[distretto] || 0;
                const safeDistrettoIdForCount = distretto.replace(/[\s.]+/g, '-');
                const checkbox = document.getElementById(`checkbox-${safeDistrettoIdForCount}`);
                if (checkbox) {
                    const label = checkbox.nextElementSibling;
                    if (label && count > 0) {
                        const countBadge = document.createElement('span');
                        countBadge.className = 'presidio-count';
                        countBadge.textContent = `${count} P`;
                        countBadge.title = `${count} presidi`;
                        label.appendChild(countBadge);
                    }
                }
            });

            // Apply distretto filter to presidi if URL parameter is present
            if (filteredDistretto) {
                console.log(`Applicazione filtro presidi per distretto: ${filteredDistretto}`);

                // Hide all presidi that don't belong to the filtered distretto
                allPresidiMarkers.forEach(markerData => {
                    if (normalizeForComparison(markerData.distretto) !== normalizeForComparison(filteredDistretto)) {
                        presidiVisibility[markerData.nome] = false;
                        map.removeLayer(markerData.marker);
                        // Update checkbox if it exists
                        const checkbox = document.getElementById(`presidio-${markerData.id}`);
                        if (checkbox) checkbox.checked = false;
                    }
                });

                // Zoom to filtered distretto bounds - find actual key in distrettiData
                const actualDistrettoKey = Object.keys(distrettiData).find(key => normalizeForComparison(key) === normalizeForComparison(filteredDistretto));
                if (actualDistrettoKey && distrettiData[actualDistrettoKey] && distrettiData[actualDistrettoKey].features.length > 0) {
                    const tempLayer = L.geoJSON({
                        type: 'FeatureCollection',
                        features: distrettiData[actualDistrettoKey].features
                    });
                    const bounds = tempLayer.getBounds();
                    map.fitBounds(bounds, {
                        padding: [50, 50],
                        maxZoom: 12
                    });
                }
            }

            // Context menu handlers
            document.getElementById('menu-edit').addEventListener('click', function() {
                if (editingMarker) {
                    editingMarker.options.draggable = true;
                    editingMarker.dragging.enable();
                    contextMenu.classList.remove('show');

                    // Visual feedback
                    editingMarker._icon.style.cursor = 'move';
                    editingMarker._icon.style.transform = 'scale(1.3)';
                }
            });

            document.getElementById('menu-save').addEventListener('click', async function() {
                if (editingMarker) {
                    const latlng = editingMarker.getLatLng();
                    const nome = editingMarker.presidioData.nome;

                    try {
                        const response = await fetch(BASE_PATH + '/api/update-presidio', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                nome: nome,
                                lat: latlng.lat,
                                lon: latlng.lng
                            })
                        });

                        const result = await response.json();

                        if (result.success) {
                            // Disable dragging
                            editingMarker.options.draggable = false;
                            editingMarker.dragging.disable();

                            // Reset visual feedback
                            editingMarker._icon.style.cursor = '';
                            editingMarker._icon.style.transform = '';

                            alert(`‚úì Posizione salvata per ${nome}`);
                        } else {
                            alert(`‚úó Errore nel salvataggio: ${result.error}`);
                        }
                    } catch (error) {
                        alert(`‚úó Errore nel salvataggio: ${error.message}`);
                    }

                    contextMenu.classList.remove('show');
                    editingMarker = null;
                }
            });

            // Change icon menu handler
            document.getElementById('menu-change-icon').addEventListener('click', function() {
                if (editingMarker) {
                    contextMenu.classList.remove('show');

                    // Open icon selection modal
                    const iconModal = document.getElementById('modal-change-icon');
                    iconModal.classList.add('show');

                    // Get current icon type
                    const currentIcon = presidiIcons[editingMarker.presidioData.nome] || 'hospital';

                    // Select current icon in modal
                    document.querySelectorAll('.icon-option').forEach(option => {
                        option.classList.remove('selected');
                        if (option.dataset.icon === currentIcon) {
                            option.classList.add('selected');
                        }
                    });
                }
            });

            // Delete presidio menu handler
            document.getElementById('menu-delete').addEventListener('click', async function() {
                if (editingMarker) {
                    const nome = editingMarker.presidioData.nome;
                    const isCustom = editingMarker.presidioData.isCustom;

                    contextMenu.classList.remove('show');

                    // Conferma eliminazione
                    if (!confirm(`Sei sicuro di voler eliminare il presidio "${nome}"?`)) {
                        editingMarker = null;
                        return;
                    }

                    if (isCustom) {
                        // Elimina presidio custom (solo locale)
                        const index = customPresidi.findIndex(p => p.nome === nome);
                        if (index > -1) {
                            customPresidi.splice(index, 1);
                            saveCustomPresidi();
                        }

                        // Rimuovi marker dalla mappa
                        map.removeLayer(editingMarker);

                        // Rimuovi da allPresidiMarkers
                        const markerIndex = allPresidiMarkers.findIndex(m => m.nome === nome);
                        if (markerIndex > -1) {
                            allPresidiMarkers.splice(markerIndex, 1);
                        }

                        alert(`‚úì Presidio custom "${nome}" eliminato`);
                    } else {
                        // Elimina presidio dal server
                        try {
                            const response = await fetch(BASE_PATH + '/api/delete-presidio', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ nome: nome })
                            });

                            const result = await response.json();

                            if (result.success) {
                                // Rimuovi marker dalla mappa
                                map.removeLayer(editingMarker);

                                // Rimuovi da allPresidiMarkers
                                const markerIndex = allPresidiMarkers.findIndex(m => m.nome === nome);
                                if (markerIndex > -1) {
                                    allPresidiMarkers.splice(markerIndex, 1);
                                }

                                // Rimuovi da presidiMarkers per distretto
                                const distretto = editingMarker.presidioData.distretto;
                                if (distretto && presidiMarkers[distretto]) {
                                    const distrettoIndex = presidiMarkers[distretto].findIndex(m => m.presidioData.nome === nome);
                                    if (distrettoIndex > -1) {
                                        presidiMarkers[distretto].splice(distrettoIndex, 1);
                                    }
                                }

                                alert(`‚úì Presidio "${nome}" eliminato`);
                            } else {
                                alert(`‚úó Errore nell'eliminazione: ${result.error}`);
                            }
                        } catch (error) {
                            alert(`‚úó Errore nell'eliminazione: ${error.message}`);
                        }
                    }

                    editingMarker = null;
                }
            });

            // Icon selection modal handlers
            const iconModal = document.getElementById('modal-change-icon');
            let selectedIcon = null;

            // Click on icon option to select
            document.querySelectorAll('.icon-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.icon-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedIcon = this.dataset.icon;
                });
            });

            // Cancel button
            document.getElementById('modal-icon-cancel-btn').addEventListener('click', function() {
                iconModal.classList.remove('show');
                selectedIcon = null;
            });

            // Confirm button
            document.getElementById('modal-icon-confirm-btn').addEventListener('click', function() {
                if (editingMarker && selectedIcon) {
                    const nome = editingMarker.presidioData.nome;

                    // Update icon preference
                    presidiIcons[nome] = selectedIcon;
                    savePresidiIcons();

                    // Update marker icon
                    const newIcon = L.divIcon({
                        className: 'presidio-marker',
                        html: getIconHTML(selectedIcon),
                        iconSize: [28, 28],
                        iconAnchor: [14, 14]
                    });
                    editingMarker.setIcon(newIcon);

                    iconModal.classList.remove('show');
                    selectedIcon = null;

                    alert(`‚úì Icona cambiata per "${nome}"`);
                }
            });

            // Close modal on click outside
            iconModal.addEventListener('click', function(e) {
                if (e.target === iconModal) {
                    iconModal.classList.remove('show');
                    selectedIcon = null;
                }
            });

            // Function to calculate distance between two points (Haversine formula)
            function calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371; // Earth's radius in km
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                          Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c; // Distance in km
            }

            // Clear distance measurement
            function clearDistanceMeasurement() {
                if (distanceLine) {
                    map.removeLayer(distanceLine);
                    distanceLine = null;
                }
                if (roadRouteLine) {
                    map.removeLayer(roadRouteLine);
                    roadRouteLine = null;
                }
                distanceMarkers.forEach(marker => map.removeLayer(marker));
                distanceMarkers = [];
                measuringDistance = false;
                firstMeasurePoint = null;

                // Remove measuring cursor class from all markers
                allPresidiMarkers.forEach(md => {
                    if (md.marker._icon) {
                        md.marker._icon.style.cursor = '';
                    }
                });
            }

            // Measure distance menu item
            document.getElementById('menu-measure').addEventListener('click', function() {
                if (editingMarker) {
                    // Clear any previous measurement
                    clearDistanceMeasurement();

                    // Start measuring
                    measuringDistance = true;
                    firstMeasurePoint = {
                        marker: editingMarker,
                        latlng: editingMarker.getLatLng(),
                        nome: editingMarker.presidioData.nome
                    };

                    // Visual feedback - change cursor
                    allPresidiMarkers.forEach(md => {
                        if (md.marker._icon) {
                            md.marker._icon.style.cursor = 'crosshair';
                        }
                    });

                    // Add marker to first point
                    const marker1 = L.circleMarker(firstMeasurePoint.latlng, {
                        radius: 8,
                        fillColor: '#f59e0b',
                        color: 'white',
                        weight: 2,
                        fillOpacity: 1
                    }).addTo(map);
                    distanceMarkers.push(marker1);

                    contextMenu.classList.remove('show');
                    alert(`Primo punto selezionato: ${firstMeasurePoint.nome}\nClicca su un altro presidio per misurare la distanza.`);
                }
            });

            // Handle click on presidio when measuring distance
            async function handlePresidioClickForDistance(marker, latlng, nome) {
                if (measuringDistance && firstMeasurePoint) {
                    // Calculate straight-line distance
                    const straightDistance = calculateDistance(
                        firstMeasurePoint.latlng.lat,
                        firstMeasurePoint.latlng.lng,
                        latlng.lat,
                        latlng.lng
                    );

                    // Add marker to second point
                    const marker2 = L.circleMarker(latlng, {
                        radius: 8,
                        fillColor: '#f59e0b',
                        color: 'white',
                        weight: 2,
                        fillOpacity: 1
                    }).addTo(map);
                    distanceMarkers.push(marker2);

                    // Draw line between points
                    distanceLine = L.polyline([firstMeasurePoint.latlng, latlng], {
                        color: '#f59e0b',
                        weight: 3,
                        dashArray: '10, 5'
                    }).addTo(map);

                    // Calculate midpoint for popup
                    const midpoint = L.latLng(
                        (firstMeasurePoint.latlng.lat + latlng.lat) / 2,
                        (firstMeasurePoint.latlng.lng + latlng.lng) / 2
                    );

                    const straightDistanceKm = straightDistance.toFixed(2);
                    const straightDistanceM = (straightDistance * 1000).toFixed(0);

                    // Show initial popup with straight-line distance
                    const popup = L.popup()
                        .setLatLng(midpoint)
                        .setContent(`
                            <div class="popup-title">üìè Distanza misurata</div>
                            <div class="popup-text">
                                <strong>Da:</strong> ${firstMeasurePoint.nome}<br>
                                <strong>A:</strong> ${nome}<br>
                                <br>
                                <strong>ü¶Ö Linea d'aria:</strong> ${straightDistanceKm} km (${straightDistanceM} m)<br>
                                <strong>üöó Distanza stradale:</strong> <span style="color: #f59e0b;">Calcolo in corso...</span><br>
                                <br>
                                <small style="color: #6b7280;">Clicca sulla mappa per rimuovere la misurazione</small>
                            </div>
                        `)
                        .openOn(map);

                    // Fetch road distance from OSRM (try multiple servers)
                    async function fetchRouteFromOSRM() {
                        const servers = [
                            'https://router.project-osrm.org',
                            'https://routing.openstreetmap.de/routed-car'
                        ];

                        const startLng = firstMeasurePoint.latlng.lng;
                        const startLat = firstMeasurePoint.latlng.lat;
                        const endLng = latlng.lng;
                        const endLat = latlng.lat;

                        for (const server of servers) {
                            try {
                                const osrmUrl = `${server}/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`;
                                const response = await fetch(osrmUrl, {
                                    headers: {
                                        'Accept': 'application/json'
                                    }
                                });

                                if (!response.ok) {
                                    console.warn(`OSRM server ${server} returned ${response.status}`);
                                    continue;
                                }

                                const data = await response.json();
                                if (data.code === 'Ok' && data.routes && data.routes.length > 0) {
                                    return data;
                                }
                            } catch (e) {
                                console.warn(`Failed to fetch from ${server}:`, e.message);
                            }
                        }
                        return null;
                    }

                    try {
                        const data = await fetchRouteFromOSRM();

                        if (data && data.routes && data.routes.length > 0) {
                            const route = data.routes[0];
                            const roadDistanceKm = (route.distance / 1000).toFixed(2);
                            const roadDistanceM = route.distance.toFixed(0);
                            const durationMinutes = Math.round(route.duration / 60);
                            const durationHours = Math.floor(durationMinutes / 60);
                            const durationMins = durationMinutes % 60;

                            let durationText = '';
                            if (durationHours > 0) {
                                durationText = `${durationHours}h ${durationMins}min`;
                            } else {
                                durationText = `${durationMins} min`;
                            }

                            // Draw the actual road route (keep straight line visible)
                            if (route.geometry && route.geometry.coordinates) {
                                // Convert coordinates from [lng, lat] to [lat, lng] for Leaflet
                                const routeCoords = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);

                                // Draw the road route (blue solid line)
                                roadRouteLine = L.polyline(routeCoords, {
                                    color: '#3b82f6',
                                    weight: 4,
                                    opacity: 0.8
                                }).addTo(map);

                                // Bring straight line (orange dashed) to front
                                if (distanceLine) {
                                    distanceLine.bringToFront();
                                }
                            }

                            // Update popup with road distance and duration
                            popup.setContent(`
                                <div class="popup-title">üìè Distanza misurata</div>
                                <div class="popup-text">
                                    <strong>Da:</strong> ${firstMeasurePoint.nome}<br>
                                    <strong>A:</strong> ${nome}<br>
                                    <br>
                                    <span style="display:inline-block;width:20px;height:3px;background:#f59e0b;vertical-align:middle;border-top:1px dashed #f59e0b;"></span> <strong>Linea d'aria:</strong> ${straightDistanceKm} km<br>
                                    <span style="display:inline-block;width:20px;height:3px;background:#3b82f6;vertical-align:middle;"></span> <strong>Percorso stradale:</strong> ${roadDistanceKm} km<br>
                                    <strong>‚è±Ô∏è Tempo percorrenza:</strong> ${durationText}<br>
                                    <br>
                                    <small style="color: #6b7280;">Clicca sulla mappa per rimuovere la misurazione</small>
                                </div>
                            `);
                        } else {
                            // No route found - show estimated road distance (1.4x straight line)
                            const estimatedRoadKm = (parseFloat(straightDistanceKm) * 1.4).toFixed(2);
                            popup.setContent(`
                                <div class="popup-title">üìè Distanza misurata</div>
                                <div class="popup-text">
                                    <strong>Da:</strong> ${firstMeasurePoint.nome}<br>
                                    <strong>A:</strong> ${nome}<br>
                                    <br>
                                    <strong>ü¶Ö Linea d'aria:</strong> ${straightDistanceKm} km<br>
                                    <strong>üöó Distanza stradale:</strong> ~${estimatedRoadKm} km <span style="color: #f59e0b;">(stimata)</span><br>
                                    <br>
                                    <small style="color: #6b7280;">Servizio routing non disponibile. Stima basata su fattore 1.4x.<br>Clicca sulla mappa per rimuovere.</small>
                                </div>
                            `);
                        }
                    } catch (error) {
                        console.error('Error fetching road distance:', error);
                        // Update popup with estimated distance
                        const estimatedRoadKm = (parseFloat(straightDistanceKm) * 1.4).toFixed(2);
                        popup.setContent(`
                            <div class="popup-title">üìè Distanza misurata</div>
                            <div class="popup-text">
                                <strong>Da:</strong> ${firstMeasurePoint.nome}<br>
                                <strong>A:</strong> ${nome}<br>
                                <br>
                                <strong>ü¶Ö Linea d'aria:</strong> ${straightDistanceKm} km<br>
                                <strong>üöó Distanza stradale:</strong> ~${estimatedRoadKm} km <span style="color: #f59e0b;">(stimata)</span><br>
                                <br>
                                <small style="color: #6b7280;">Servizio routing non disponibile. Stima basata su fattore 1.4x.<br>Clicca sulla mappa per rimuovere.</small>
                            </div>
                        `);
                    }

                    // Reset measuring state
                    measuringDistance = false;
                    firstMeasurePoint = null;

                    // Reset cursor
                    allPresidiMarkers.forEach(md => {
                        if (md.marker._icon) {
                            md.marker._icon.style.cursor = '';
                        }
                    });

                    return true; // Indicate that distance was measured
                }
                return false;
            }

            // Hide context menu on map click
            map.on('click', function() {
                contextMenu.classList.remove('show');
                // Clear distance measurement when clicking on map
                if (distanceLine || distanceMarkers.length > 0) {
                    clearDistanceMeasurement();
                }
            });

            // Hide context menu on scroll
            map.on('movestart', function() {
                contextMenu.classList.remove('show');
            });

            // Context menu on map (right-click)
            map.on('contextmenu', function(e) {
                // Only show "Add presidio" option on map context menu
                pendingPresidioPosition = e.latlng;
                editingMarker = null;

                // Position context menu
                const point = map.latLngToContainerPoint(e.latlng);
                const x = point.x;
                const y = point.y;

                contextMenu.style.left = x + 'px';
                contextMenu.style.top = y + 'px';
                contextMenu.classList.add('show');

                // Show only "Add presidio" option
                document.getElementById('menu-edit').style.display = 'none';
                document.getElementById('menu-save').style.display = 'none';
                document.getElementById('menu-measure').style.display = 'none';
                document.getElementById('menu-add-presidio').style.display = 'block';
            });

            // Button event listeners
            document.getElementById('btn-save').addEventListener('click', savePresidiVisibility);
            document.getElementById('btn-reset').addEventListener('click', resetPresidiVisibility);
            document.getElementById('btn-print').addEventListener('click', function() {
                printMap();
            });

            // Toggle permanent popup labels
            document.getElementById('toggle-popup-labels').addEventListener('change', function() {
                const showLabels = this.checked;
                const labelTypeSetting = document.getElementById('label-type-setting');

                // Show/hide label type options
                labelTypeSetting.style.display = showLabels ? 'block' : 'none';

                updateAllTooltips();
            });

            // Update tooltips when zoom level changes
            map.on('zoomend', function() {
                updateAllTooltips();
            });

            // Implement smooth zoom with wheel
            let isZooming = false;
            let currentFractionalZoom = map.getZoom();

            map.getContainer().addEventListener('wheel', function(e) {
                e.preventDefault();

                if (isZooming) return;
                isZooming = true;

                const delta = e.deltaY > 0 ? -0.5 : 0.5;
                currentFractionalZoom = Math.max(8, Math.min(18, currentFractionalZoom + delta));

                map.setZoom(Math.round(currentFractionalZoom), { animate: true });

                setTimeout(() => {
                    isZooming = false;
                }, 150);
            }, { passive: false });

            // Handle label type change
            document.querySelectorAll('input[name="label-type"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    // Mark that user has explicitly changed this setting
                    document.querySelectorAll('input[name="label-type"]').forEach(r => {
                        r.dataset.userChanged = 'true';
                    });
                    updateAllTooltips();
                });
            });

            // Custom presidi functions
            function loadCustomPresidi() {
                try {
                    const saved = localStorage.getItem('custom-presidi');
                    if (saved) {
                        const loaded = JSON.parse(saved);
                        customPresidi.push(...loaded);
                        console.log(`Caricati ${loaded.length} presidi custom da localStorage`);

                        // Add markers for custom presidi
                        loaded.forEach(presidio => {
                            addCustomPresidioMarker(presidio);
                        });
                    }
                } catch (error) {
                    console.error('Errore nel caricamento presidi custom:', error);
                }
            }

            function saveCustomPresidi() {
                try {
                    localStorage.setItem('custom-presidi', JSON.stringify(customPresidi));
                    console.log('Presidi custom salvati in localStorage');
                } catch (error) {
                    console.error('Errore nel salvataggio presidi custom:', error);
                }
            }

            function addCustomPresidioMarker(presidio) {
                // Get icon type for this presidio (default: hospital)
                const iconType = presidiIcons[presidio.nome] || 'hospital';

                const presidioIcon = L.divIcon({
                    className: 'presidio-marker',
                    html: getIconHTML(iconType),
                    iconSize: [28, 28],
                    iconAnchor: [14, 14]
                });

                const marker = L.marker([presidio.lat, presidio.lon], {
                    icon: presidioIcon,
                    draggable: false
                }).addTo(map);

                marker.presidioData = {
                    nome: presidio.nome,
                    indirizzo: 'Custom',
                    distretto: 'Custom',
                    comune: 'Custom',
                    isCustom: true
                };

                const popupContent = `
                    <div class="popup-title">${presidio.nome}</div>
                    <div class="popup-text">
                        <strong>Tipo:</strong> Presidio personalizzato<br>
                        <strong>Lat:</strong> ${presidio.lat.toFixed(6)}<br>
                        <strong>Lon:</strong> ${presidio.lon.toFixed(6)}
                    </div>
                `;

                marker.on('click', function(e) {
                    L.popup()
                        .setLatLng(e.latlng)
                        .setContent(popupContent)
                        .openOn(map);
                });

                // Right-click for context menu (same as regular presidi)
                marker.on('contextmenu', function(e) {
                    L.DomEvent.preventDefault(e);

                    editingMarker = marker;
                    pendingPresidioPosition = null; // Clear pending position

                    // Position context menu
                    const x = e.originalEvent.pageX;
                    const y = e.originalEvent.pageY;

                    contextMenu.style.left = x + 'px';
                    contextMenu.style.top = y + 'px';
                    contextMenu.classList.add('show');

                    // Hide "Add presidio" option for marker context menu
                    document.getElementById('menu-add-presidio').style.display = 'none';

                    // Custom presidi cannot be edited, but can change icon and measure distance
                    document.getElementById('menu-edit').style.display = 'none';
                    document.getElementById('menu-save').style.display = 'none';
                    document.getElementById('menu-change-icon').style.display = 'block';
                    document.getElementById('menu-measure').style.display = 'block';
                });

                // Bind permanent tooltip (initially hidden)
                marker.tooltipContent = {
                    nome: presidio.nome,
                    comune: presidio.nome // For custom presidi, use nome for both
                };
                marker.bindTooltip(presidio.nome, {
                    permanent: true,
                    direction: 'top',
                    offset: [0, -10],
                    className: 'presidio-permanent-tooltip',
                    opacity: 0.9
                });
                marker.closeTooltip(); // Start with tooltip hidden

                // Create label for print
                const labelDiv = document.createElement('div');
                labelDiv.className = 'presidio-label';
                labelDiv.textContent = presidio.nome;
                document.body.appendChild(labelDiv);

                // Store marker with visibility data
                const markerData = {
                    id: allPresidiMarkers.length,
                    marker: marker,
                    nome: presidio.nome,
                    distretto: 'Custom',
                    comune: 'Custom',
                    lat: presidio.lat,
                    lon: presidio.lon,
                    labelDiv: labelDiv,
                    isCustom: true
                };

                allPresidiMarkers.push(markerData);
                presidiLabels[presidio.nome] = markerData;

                // Initialize visibility
                if (presidiVisibility[presidio.nome] === undefined) {
                    presidiVisibility[presidio.nome] = true;
                }

                // Show tooltip if permanent labels are enabled and zoom is sufficient
                if (shouldShowTooltips()) {
                    updateTooltipContent(marker);
                    marker.openTooltip();
                }
            }

            // Export configuration
            function exportConfiguration() {
                try {
                    const config = {
                        version: '1.0',
                        timestamp: new Date().toISOString(),
                        presidiVisibility: presidiVisibility,
                        customPresidi: customPresidi,
                        presidiIcons: presidiIcons
                    };

                    const dataStr = JSON.stringify(config, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `presidi-config-${new Date().toISOString().split('T')[0]}.json`;
                    link.click();
                    URL.revokeObjectURL(url);

                    alert('‚úì Configurazione esportata con successo!');
                } catch (error) {
                    console.error('Errore nell\'esportazione:', error);
                    alert('‚úó Errore nell\'esportazione della configurazione');
                }
            }

            // Import configuration
            function importConfiguration(file) {
                try {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const config = JSON.parse(e.target.result);

                            if (!config.version || !config.presidiVisibility) {
                                alert('‚úó File di configurazione non valido');
                                return;
                            }

                            // Import presidiVisibility
                            Object.assign(presidiVisibility, config.presidiVisibility);

                            // Import presidiIcons
                            if (config.presidiIcons) {
                                Object.assign(presidiIcons, config.presidiIcons);
                                savePresidiIcons();
                            }

                            // Apply visibility and icons to existing presidi
                            allPresidiMarkers.forEach(markerData => {
                                const visible = presidiVisibility[markerData.nome] !== false;
                                if (visible) {
                                    map.addLayer(markerData.marker);
                                } else {
                                    map.removeLayer(markerData.marker);
                                }

                                // Update icon if preference exists
                                const iconType = presidiIcons[markerData.nome];
                                if (iconType) {
                                    const newIcon = L.divIcon({
                                        className: 'presidio-marker',
                                        html: getIconHTML(iconType),
                                        iconSize: [28, 28],
                                        iconAnchor: [14, 14]
                                    });
                                    markerData.marker.setIcon(newIcon);
                                }

                                // Update checkbox if exists
                                const checkbox = document.getElementById(`presidio-${markerData.id}`);
                                if (checkbox) checkbox.checked = visible;
                            });

                            // Import custom presidi
                            if (config.customPresidi && config.customPresidi.length > 0) {
                                // Remove old custom presidi markers
                                const customMarkers = allPresidiMarkers.filter(md => md.isCustom);
                                customMarkers.forEach(md => {
                                    map.removeLayer(md.marker);
                                    if (md.labelDiv && md.labelDiv.parentNode) {
                                        md.labelDiv.parentNode.removeChild(md.labelDiv);
                                    }
                                    const index = allPresidiMarkers.indexOf(md);
                                    if (index > -1) {
                                        allPresidiMarkers.splice(index, 1);
                                    }
                                });

                                // Clear and add new custom presidi
                                customPresidi.length = 0;
                                customPresidi.push(...config.customPresidi);

                                // Add markers for imported custom presidi
                                config.customPresidi.forEach(presidio => {
                                    addCustomPresidioMarker(presidio);
                                });

                                // Save to localStorage
                                saveCustomPresidi();
                            }

                            // Save visibility to localStorage
                            savePresidiVisibility();

                            alert(`‚úì Configurazione importata con successo!\n${config.customPresidi ? config.customPresidi.length : 0} presidi custom caricati`);
                        } catch (parseError) {
                            console.error('Errore nel parsing del file:', parseError);
                            alert('‚úó Errore nel parsing del file di configurazione');
                        }
                    };
                    reader.readAsText(file);
                } catch (error) {
                    console.error('Errore nell\'importazione:', error);
                    alert('‚úó Errore nell\'importazione della configurazione');
                }
            }

            // Export button event listener
            document.getElementById('btn-export').addEventListener('click', exportConfiguration);

            // Import button event listener
            document.getElementById('btn-import').addEventListener('click', function() {
                document.getElementById('import-file-input').click();
            });

            document.getElementById('import-file-input').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    importConfiguration(file);
                }
                // Reset input
                e.target.value = '';
            });

            // Modal handlers for adding custom presidio
            const modal = document.getElementById('modal-add-presidio');
            const presidioNameInput = document.getElementById('presidio-name-input');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');

            document.getElementById('menu-add-presidio').addEventListener('click', function() {
                if (pendingPresidioPosition) {
                    contextMenu.classList.remove('show');
                    modal.classList.add('show');
                    presidioNameInput.value = '';
                    presidioNameInput.focus();
                }
            });

            modalCancelBtn.addEventListener('click', function() {
                modal.classList.remove('show');
                pendingPresidioPosition = null;
            });

            modalConfirmBtn.addEventListener('click', function() {
                const nome = presidioNameInput.value.trim();
                if (!nome) {
                    alert('Inserisci un nome per il presidio');
                    return;
                }

                if (pendingPresidioPosition) {
                    // Check if presidio with same name exists
                    const exists = customPresidi.find(p => p.nome === nome);
                    if (exists) {
                        alert('Esiste gi√† un presidio con questo nome');
                        return;
                    }

                    // Add custom presidio
                    const presidio = {
                        nome: nome,
                        lat: pendingPresidioPosition.lat,
                        lon: pendingPresidioPosition.lng
                    };

                    customPresidi.push(presidio);
                    addCustomPresidioMarker(presidio);
                    saveCustomPresidi();

                    modal.classList.remove('show');
                    pendingPresidioPosition = null;

                    alert(`‚úì Presidio "${nome}" aggiunto con successo!`);
                }
            });

            // Close modal on click outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.remove('show');
                    pendingPresidioPosition = null;
                }
            });

            // Handle Enter key in modal input
            presidioNameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    modalConfirmBtn.click();
                }
            });

            // Load custom presidi on startup
            loadCustomPresidi();

            // Print function
            function printMap() {
                // Get all visible presidi
                const visiblePresidi = allPresidiMarkers.filter(md =>
                    presidiVisibility[md.nome] !== false
                );

                if (visiblePresidi.length === 0) {
                    alert('Nessun presidio visibile da stampare!');
                    return;
                }

                // Get selected label type
                const labelType = document.querySelector('input[name="print-label"]:checked').value;

                // Calculate bounds of visible presidi
                const bounds = L.latLngBounds(
                    visiblePresidi.map(md => [md.lat, md.lon])
                );

                // Store current view
                const currentCenter = map.getCenter();
                const currentZoom = map.getZoom();

                // Fit to visible presidi with padding
                map.fitBounds(bounds, {
                    padding: [100, 100],
                    maxZoom: 14
                });

                // Position labels for visible presidi
                setTimeout(() => {
                    visiblePresidi.forEach(markerData => {
                        const point = map.latLngToContainerPoint([markerData.lat, markerData.lon]);
                        const markerInfo = presidiLabels[markerData.nome];
                        if (markerInfo && markerInfo.labelDiv) {
                            const label = markerInfo.labelDiv;

                            // Update label text based on selection
                            if (labelType === 'comune') {
                                // Use comune (which is the quartiere for Messina)
                                label.textContent = markerInfo.comune || markerInfo.nome;
                            } else {
                                // Use nome presidio
                                label.textContent = markerInfo.nome;
                            }

                            label.style.left = point.x + 'px';
                            label.style.top = point.y + 'px';
                        }
                    });

                    // Hide labels for non-visible presidi
                    allPresidiMarkers.forEach(markerData => {
                        if (presidiVisibility[markerData.nome] === false) {
                            const markerInfo = presidiLabels[markerData.nome];
                            if (markerInfo && markerInfo.labelDiv) {
                                markerInfo.labelDiv.style.display = 'none';
                            }
                        }
                    });

                    // Trigger print dialog
                    setTimeout(() => {
                        window.print();

                        // Restore view after print
                        setTimeout(() => {
                            map.setView(currentCenter, currentZoom);
                            // Reset label display and text
                            allPresidiMarkers.forEach(markerData => {
                                const markerInfo = presidiLabels[markerData.nome];
                                if (markerInfo && markerInfo.labelDiv) {
                                    markerInfo.labelDiv.style.display = '';
                                    // Reset to nome presidio
                                    markerInfo.labelDiv.textContent = markerInfo.nome;
                                }
                            });
                        }, 500);
                    }, 500);
                }, 500);
            }

        }).catch(error => {
            console.error('Errore nel caricamento dei dati:', error);
            alert('Errore nel caricamento dei dati. Controlla la console.');
        });
        }

        // Toggle legend badge visibility
        function setupLegendToggle() {
            const legendBadge = document.getElementById('distretti-legend-badge');
            const toggleBtn = document.getElementById('toggle-legend-btn');
            const closeBtn = document.getElementById('close-legend-btn');

            // Close legend
            closeBtn.addEventListener('click', function() {
                legendBadge.classList.add('hidden');
                toggleBtn.classList.add('visible');
            });

            // Open legend
            toggleBtn.addEventListener('click', function() {
                legendBadge.classList.remove('hidden');
                toggleBtn.classList.remove('visible');
            });
        }

        // Initialize the app
        initApp();
        setupLegendToggle();
    </script>
</body>
</html>
